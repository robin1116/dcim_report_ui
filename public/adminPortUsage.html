<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>포트 사용량 모니터링 | simpleEye DCIM</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Custom CSS -->
    <link href="css/themes.css" rel="stylesheet">
    <link href="css/modern-admin.css" rel="stylesheet">
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle-container">
        <button id="themeToggle" class="theme-toggle-btn" title="테마 변경">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-logo">
                    <svg width="40" height="40" viewBox="0 0 40 40" class="logo-icon">
                        <defs>
                            <linearGradient id="sidebarLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:var(--primary-color)"/>
                                <stop offset="100%" style="stop-color:var(--secondary-color)"/>
                            </linearGradient>
                        </defs>
                        <circle cx="10" cy="10" r="3" fill="url(#sidebarLogoGradient)"/>
                        <circle cx="20" cy="10" r="3" fill="url(#sidebarLogoGradient)" opacity="0.7"/>
                        <circle cx="30" cy="10" r="3" fill="url(#sidebarLogoGradient)" opacity="0.5"/>
                        <rect x="5" y="20" width="30" height="2" rx="1" fill="url(#sidebarLogoGradient)"/>
                        <text x="8" y="35" font-family="Arial, sans-serif" font-size="8" fill="url(#sidebarLogoGradient)" font-weight="bold">Eye</text>
                    </svg>
                    <span class="logo-text">죽전 퍼시픽써니 DC</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">조회 보고서</div>
                    <div class="nav-item">
                        <a href="powerInquiry.html" class="nav-link active">
                            <i class="fas fa-bolt"></i>
                            <span class="nav-text">전력조회</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="faultInquiry.html" class="nav-link">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="nav-text">장애조회</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">설정</div>
                    <div class="nav-item">
                        <a href="alarmConfig.html" class="nav-link">
                            <i class="fas fa-bell"></i>
                            <span class="nav-text">장애 설정</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="alarmLevelConfig.html" class="nav-link">
                            <i class="fas fa-layer-group"></i>
                            <span class="nav-text">장애등급 설정</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">사용자관리</div>
                    <div class="nav-item">
                        <a href="adminsysuser.html" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span class="nav-text">사용자관리</span>
                        </a>
                    </div>
                </div>
            </nav>

            <div class="sidebar-user">
                <div class="user-profile">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name">관리자</div>
                        <div class="user-role">시스템 관리자</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-content">
                    <div class="header-left">
                        <button class="sidebar-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <h1 class="page-title">포트 사용량 모니터링</h1>
                            <nav class="breadcrumb-custom">
                                <a href="#">simpleEye</a>
                                <i class="fas fa-chevron-right"></i>
                                <span>모니터링</span>
                                <i class="fas fa-chevron-right"></i>
                                <strong>포트 사용량</strong>
                            </nav>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn" id="refreshData" title="데이터 새로고침">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="header-btn" id="exportData" title="데이터 내보내기">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="header-btn has-notification" title="알림">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="header-btn" title="설정">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="header-btn" title="로그아웃">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Filter Controls -->
                <div class="modern-card mb-4">
                    <div class="card-body-modern">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label class="form-label-modern">서버 그룹</label>
                                <select class="form-control form-control-modern" id="serverGroup">
                                    <option value="">전체 서버</option>
                                    <option value="web">웹 서버</option>
                                    <option value="db">데이터베이스 서버</option>
                                    <option value="storage">스토리지 서버</option>
                                    <option value="network">네트워크 장비</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-modern">기간</label>
                                <select class="form-control form-control-modern" id="timePeriod">
                                    <option value="1h">최근 1시간</option>
                                    <option value="24h" selected>최근 24시간</option>
                                    <option value="7d">최근 7일</option>
                                    <option value="30d">최근 30일</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-modern">포트 타입</label>
                                <select class="form-control form-control-modern" id="portType">
                                    <option value="">모든 포트</option>
                                    <option value="ethernet">이더넷</option>
                                    <option value="fiber">파이버</option>
                                    <option value="copper">구리</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary-modern" id="applyFilter">
                                        <i class="fas fa-filter"></i>
                                        필터 적용
                                    </button>
                                    <button class="btn btn-secondary-modern" id="resetFilter">
                                        <i class="fas fa-undo"></i>
                                        초기화
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="modern-card">
                            <div class="card-body-modern text-center">
                                <div class="stat-icon mb-3">
                                    <i class="fas fa-ethernet text-gradient" style="font-size: 2.5rem;"></i>
                                </div>
                                <h3 class="mb-1" id="totalPorts">-</h3>
                                <p class="text-muted mb-0">전체 포트</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="modern-card">
                            <div class="card-body-modern text-center">
                                <div class="stat-icon mb-3">
                                    <i class="fas fa-plug text-gradient" style="font-size: 2.5rem;"></i>
                                </div>
                                <h3 class="mb-1" id="activePorts">-</h3>
                                <p class="text-muted mb-0">사용 중인 포트</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="modern-card">
                            <div class="card-body-modern text-center">
                                <div class="stat-icon mb-3">
                                    <i class="fas fa-chart-line text-gradient" style="font-size: 2.5rem;"></i>
                                </div>
                                <h3 class="mb-1" id="avgUtilization">-</h3>
                                <p class="text-muted mb-0">평균 사용률</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="modern-card">
                            <div class="card-body-modern text-center">
                                <div class="stat-icon mb-3">
                                    <i class="fas fa-exclamation-triangle text-gradient" style="font-size: 2.5rem;"></i>
                                </div>
                                <h3 class="mb-1" id="alertCount">-</h3>
                                <p class="text-muted mb-0">알림 발생</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row mb-4">
                    <div class="col-lg-8">
                        <div class="modern-card">
                            <div class="card-header-modern">
                                <h3 class="card-title-modern">포트 사용량 추이</h3>
                                <div class="dropdown">
                                    <button class="btn btn-secondary-modern dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" id="exportChart"><i class="fas fa-download me-2"></i>차트 내보내기</a></li>
                                        <li><a class="dropdown-item" href="#" id="fullscreenChart"><i class="fas fa-expand me-2"></i>전체화면</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body-modern">
                                <div class="chart-container">
                                    <canvas id="usageChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="modern-card">
                            <div class="card-header-modern">
                                <h3 class="card-title-modern">포트 상태 분포</h3>
                            </div>
                            <div class="card-body-modern">
                                <div class="chart-container">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Port Details Table -->
                <div class="modern-card">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">포트 상세 정보</h3>
                        <div class="d-flex gap-2">
                            <button class="btn btn-secondary-modern" id="bulkAction" disabled>
                                <i class="fas fa-tasks"></i>
                                일괄 작업
                            </button>
                            <button class="btn btn-primary-modern" id="addPort">
                                <i class="fas fa-plus"></i>
                                포트 추가
                            </button>
                        </div>
                    </div>
                    <div class="card-body-modern">
                        <div class="table-container">
                            <table id="portsTable" class="table table-modern" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="form-check-input" id="selectAll">
                                        </th>
                                        <th>포트 ID</th>
                                        <th>서버명</th>
                                        <th>포트 타입</th>
                                        <th>상태</th>
                                        <th>사용률</th>
                                        <th>대역폭</th>
                                        <th>마지막 업데이트</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="js/admin-common.js"></script>
    <script src="js/toast-notifications.js"></script>

    <script>
        $(document).ready(function() {
            let portsTable;
            let usageChart;
            let statusChart;

            // Initialize DataTable
            portsTable = $('#portsTable').DataTable({
                ...window.DataTableDefaults,
                ajax: {
                    url: '/api/port-usage',
                    dataSrc: function(json) {
                        // Generate mock port data
                        const ports = [];
                        const servers = ['WEB-01', 'WEB-02', 'DB-01', 'DB-02', 'STORAGE-01', 'NET-01'];
                        const types = ['ethernet', 'fiber', 'copper'];
                        const statuses = ['active', 'inactive', 'warning', 'error'];
                        
                        for (let i = 1; i <= 50; i++) {
                            ports.push({
                                id: `PORT-${i.toString().padStart(3, '0')}`,
                                server: servers[Math.floor(Math.random() * servers.length)],
                                type: types[Math.floor(Math.random() * types.length)],
                                status: statuses[Math.floor(Math.random() * statuses.length)],
                                utilization: Math.floor(Math.random() * 100),
                                bandwidth: ['1Gbps', '10Gbps', '40Gbps'][Math.floor(Math.random() * 3)],
                                lastUpdate: new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000).toISOString()
                            });
                        }
                        return ports;
                    }
                },
                columns: [
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row, meta) {
                            return `<input type="checkbox" class="form-check-input row-select" value="${row.id}">`;
                        }
                    },
                    { data: 'id' },
                    { data: 'server' },
                    { 
                        data: 'type',
                        render: function(data) {
                            const icons = {
                                ethernet: 'fas fa-ethernet',
                                fiber: 'fas fa-wifi',
                                copper: 'fas fa-plug'
                            };
                            return `<i class="${icons[data]} me-2"></i>${data.toUpperCase()}`;
                        }
                    },
                    {
                        data: 'status',
                        render: function(data) {
                            const classes = {
                                active: 'status-active',
                                inactive: 'status-inactive',
                                warning: 'status-pending',
                                error: 'status-inactive'
                            };
                            const labels = {
                                active: '정상',
                                inactive: '비활성',
                                warning: '경고',
                                error: '오류'
                            };
                            return `<span class="status-badge ${classes[data]}">${labels[data]}</span>`;
                        }
                    },
                    {
                        data: 'utilization',
                        render: function(data) {
                            const color = data > 80 ? 'danger' : data > 60 ? 'warning' : 'success';
                            return `
                                <div class="d-flex align-items-center">
                                    <div class="progress me-2" style="width: 60px; height: 8px;">
                                        <div class="progress-bar bg-${color}" style="width: ${data}%"></div>
                                    </div>
                                    <span class="text-${color} fw-bold">${data}%</span>
                                </div>
                            `;
                        }
                    },
                    { data: 'bandwidth' },
                    {
                        data: 'lastUpdate',
                        render: function(data) {
                            return window.AdminUtils.formatDateTime(data);
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return `
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm-modern btn-secondary-modern view-details-btn" 
                                            data-port='${JSON.stringify(row)}' title="상세보기">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm-modern btn-primary-modern edit-port-btn" 
                                            data-port='${JSON.stringify(row)}' title="수정">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm-modern btn-danger-modern delete-port-btn" 
                                            data-id="${row.id}" title="삭제">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ],
                drawCallback: function() {
                    updateStatistics();
                    updateBulkActionButton();
                }
            });

            // Initialize Charts
            initializeCharts();

            // Update statistics
            function updateStatistics() {
                const data = portsTable.data();
                const totalPorts = data.length;
                const activePorts = data.filter(port => port.status === 'active').length;
                const avgUtilization = Math.round(data.reduce((sum, port) => sum + port.utilization, 0) / totalPorts);
                const alertCount = data.filter(port => port.status === 'warning' || port.status === 'error').length;

                $('#totalPorts').text(totalPorts);
                $('#activePorts').text(activePorts);
                $('#avgUtilization').text(avgUtilization + '%');
                $('#alertCount').text(alertCount);
            }

            // Initialize charts
            function initializeCharts() {
                // Usage trend chart
                const usageCtx = document.getElementById('usageChart').getContext('2d');
                usageChart = new Chart(usageCtx, {
                    type: 'line',
                    data: {
                        labels: generateTimeLabels(),
                        datasets: [{
                            label: '평균 사용률',
                            data: generateUsageData(),
                            borderColor: 'rgb(3, 52, 149)',
                            backgroundColor: 'rgba(3, 52, 149, 0.1)',
                            fill: true,
                            tension: 0.4
                        }, {
                            label: '최대 사용률',
                            data: generateUsageData(20),
                            borderColor: 'rgb(174, 228, 255)',
                            backgroundColor: 'rgba(174, 228, 255, 0.1)',
                            fill: false,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });

                // Status distribution chart
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['정상', '경고', '오류', '비활성'],
                        datasets: [{
                            data: [70, 15, 5, 10],
                            backgroundColor: [
                                'rgba(25, 135, 84, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(220, 53, 69, 0.8)',
                                'rgba(108, 117, 125, 0.8)'
                            ],
                            borderColor: [
                                'rgb(25, 135, 84)',
                                'rgb(255, 193, 7)',
                                'rgb(220, 53, 69)',
                                'rgb(108, 117, 125)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Generate time labels for chart
            function generateTimeLabels() {
                const labels = [];
                const now = new Date();
                for (let i = 23; i >= 0; i--) {
                    const time = new Date(now.getTime() - i * 60 * 60 * 1000);
                    labels.push(time.getHours().toString().padStart(2, '0') + ':00');
                }
                return labels;
            }

            // Generate usage data for chart
            function generateUsageData(offset = 0) {
                const data = [];
                for (let i = 0; i < 24; i++) {
                    data.push(Math.floor(Math.random() * 60) + 20 + offset);
                }
                return data;
            }

            // Select all checkbox
            $('#selectAll').change(function() {
                $('.row-select').prop('checked', this.checked);
                updateBulkActionButton();
            });

            // Individual row select
            $(document).on('change', '.row-select', function() {
                updateBulkActionButton();
                const totalRows = $('.row-select').length;
                const checkedRows = $('.row-select:checked').length;
                $('#selectAll').prop('checked', totalRows === checkedRows);
                $('#selectAll').prop('indeterminate', checkedRows > 0 && checkedRows < totalRows);
            });

            // Update bulk action button
            function updateBulkActionButton() {
                const selectedCount = $('.row-select:checked').length;
                $('#bulkAction').prop('disabled', selectedCount === 0);
                if (selectedCount > 0) {
                    $('#bulkAction').html(`<i class="fas fa-tasks"></i> 일괄 작업 (${selectedCount})`);
                } else {
                    $('#bulkAction').html('<i class="fas fa-tasks"></i> 일괄 작업');
                }
            }

            // Filter functionality
            $('#applyFilter').click(function() {
                window.ToastNotifications.info('필터가 적용되었습니다.');
                portsTable.ajax.reload();
            });

            $('#resetFilter').click(function() {
                $('#serverGroup, #timePeriod, #portType').val('');
                $('#timePeriod').val('24h');
                window.ToastNotifications.info('필터가 초기화되었습니다.');
                portsTable.ajax.reload();
            });

            // Refresh data
            $('#refreshData').click(function() {
                const btn = $(this);
                btn.find('i').addClass('fa-spin');
                portsTable.ajax.reload();
                usageChart.data.datasets[0].data = generateUsageData();
                usageChart.data.datasets[1].data = generateUsageData(20);
                usageChart.update();
                setTimeout(() => {
                    btn.find('i').removeClass('fa-spin');
                    window.ToastNotifications.success('데이터가 새로고침되었습니다.');
                }, 1000);
            });

            // Export data
            $('#exportData').click(function() {
                window.ToastNotifications.info('데이터를 내보내는 중입니다...');
                // In production, this would trigger actual export
                setTimeout(() => {
                    window.ToastNotifications.success('데이터 내보내기가 완료되었습니다.');
                }, 2000);
            });

            // Auto refresh every 30 seconds
            setInterval(() => {
                portsTable.ajax.reload(null, false);
                usageChart.data.datasets[0].data = generateUsageData();
                usageChart.data.datasets[1].data = generateUsageData(20);
                usageChart.update('none');
            }, 30000);
        });
    </script>
</body>
</html>
