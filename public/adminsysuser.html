<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시스템관리자 | 삼송 데이터센터 DCIM</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Custom CSS -->
    <link href="css/themes.css" rel="stylesheet">
    <link href="css/modern-admin.css" rel="stylesheet">
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="logo-text">삼송 데이터센터</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">조회 보고서</div>
                    <div class="nav-item">
                        <a href="powerInquiry.html" class="nav-link">
                            <i class="fas fa-bolt"></i>
                            <span class="nav-text">전력조회</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="faultInquiry.html" class="nav-link">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="nav-text">장애조회</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">설정</div>
                    <div class="nav-item">
                        <a href="alarmSetting.html" class="nav-link">
                            <i class="fas fa-bell"></i>
                            <span class="nav-text">장애임계치 설정</span>
                        </a>
                    </div>

                </div>

                <div class="nav-section">
                    <div class="nav-section-title">사용자관리</div>
                    <div class="nav-item">
                        <a href="adminsysuser.html" class="nav-link active">
                            <i class="fas fa-users"></i>
                            <span class="nav-text">사용자관리</span>
                        </a>
                    </div>
                </div>
            </nav>

            <div class="sidebar-user">
                <div class="user-profile">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name">관리자</div>
                        <div class="user-role">시스템 관리자</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-content">
                    <div class="header-left">
                        <button class="sidebar-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <h1 class="page-title">사용자관리</h1>
                            <nav class="breadcrumb-custom">
                                <a href="#">삼송 데이터센터</a>
                                <i class="fas fa-chevron-right"></i>
                                <span>사용자관리</span>
                                <i class="fas fa-chevron-right"></i>
                                <strong>사용자관리</strong>
                            </nav>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn has-notification" title="알림">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="header-btn" title="설정">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="header-btn" title="로그아웃">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <div class="content-area">


                <!-- User Management Table -->
                <div class="modern-card">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">사용자 목록</h3>
                        <button class="btn btn-primary-modern" data-bs-toggle="modal" data-bs-target="#registerModal">
                            <i class="fas fa-plus"></i>
                            계정 등록
                        </button>
                    </div>
                    <div class="card-body-modern">
                        <div class="table-container">
                            <table id="usersTable" class="table table-modern" style="width:100%">
                                <thead>
                                    <tr>
                                        <th style="text-align: center;">아이디</th>
                                        <th style="text-align: center;">이름</th>
                                        <th style="text-align: center;">권한</th>
                                        <th style="text-align: center;">비고</th>
                                        <th style="text-align: center;">가입일</th>
                                        <th style="text-align: center;">작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Register Modal -->
    <div class="modal fade modal-modern" id="registerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">새 계정 등록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">아이디</label>
                                    <div class="input-group">
                                        <input type="text" id="newUserId" class="form-control form-control-modern" required>
                                        <button type="button" class="btn btn-secondary-modern btn-sm-modern" id="checkIdBtn">중복확인</button>
                                    </div>
                                    <div class="form-text">4-20자의 영문, 숫자만 사용 가능</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">이름</label>
                                    <input type="text" id="newUserName" class="form-control form-control-modern" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">비밀번호</label>
                                    <input type="password" id="newUserPassword" class="form-control form-control-modern" required>
                                    <div class="form-text">8자 이상, 영문, 숫자, 특수문자 포함</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">비밀번호 확인</label>
                                    <input type="password" id="confirmPassword" class="form-control form-control-modern" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">권한</label>
                                    <select id="newUserRole" class="form-control form-control-modern" required>
                                        <option value="">권한을 선택하세요</option>
                                        <option value="관리자">관리자</option>
                                        <option value="운영자">운영자</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">비고</label>
                                    <input type="text" id="newUserNotes" class="form-control form-control-modern" placeholder="메모사항을 입력하세요">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary-modern" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary-modern" id="registerUserBtn">
                        <i class="fas fa-save"></i>
                        등록
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade modal-modern" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">사용자 정보 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs mb-4">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#userInfoTab">기본 정보</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#passwordTab">비밀번호 변경</button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="userInfoTab">
                            <form id="editUserForm">
                                <input type="hidden" id="editUserId">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label-modern">아이디</label>
                                            <input type="text" id="editUserIdDisplay" class="form-control form-control-modern" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label-modern">이름</label>
                                            <input type="text" id="editUserName" class="form-control form-control-modern" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label-modern">권한</label>
                                            <select id="editUserRole" class="form-control form-control-modern" required>
                                                <option value="관리자">관리자</option>
                                                <option value="운영자">운영자</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label-modern">비고</label>
                                            <input type="text" id="editUserNotes" class="form-control form-control-modern" placeholder="메모사항을 입력하세요">
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="passwordTab">
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label class="form-label-modern">새 비밀번호</label>
                                    <input type="password" id="newPassword" class="form-control form-control-modern" required>
                                    <div class="form-text">8자 이상, 영문, 숫자, 특수문자 포함</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label-modern">새 비밀번호 확인</label>
                                    <input type="password" id="confirmNewPassword" class="form-control form-control-modern" required>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary-modern" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary-modern" id="saveChangesBtn">
                        <i class="fas fa-save"></i>
                        저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <script src="js/admin-common.js"></script>
    <script src="js/toast-notifications.js"></script>

    <script>
        $(document).ready(function() {
            let usersTable;
            let currentEditingUser = null;
            let usersData = [];

            // Initialize DataTable
            usersTable = $('#usersTable').DataTable({
                data: [],
                pageLength: 10,
                language: {
                    lengthMenu: "_MENU_ 개씩 보기",
                    info: "_START_ - _END_ / _TOTAL_ 건",
                    search: "검색:",
                    paginate: { next: "다음", previous: "이전" }
                },
                columns: [
                    { 
                        data: 'username', 
                        title: '아이디',
                        className: 'text-center'
                    },
                    { 
                        data: 'name', 
                        title: '이름',
                        className: 'text-center'
                    },
                    { 
                        data: 'role', 
                        title: '권한',
                        className: 'text-center'
                    },
                    { 
                        data: 'notes', 
                        title: '비고',
                        className: 'text-center'
                    },
                    { 
                        data: 'joinDate', 
                        title: '가입일',
                        className: 'text-center',
                        render: function(data) {
                            return new Date(data).toLocaleDateString('ko-KR');
                        }
                    },
                    {
                        data: null,
                        title: '작업',
                        className: 'text-center',
                        orderable: false,
                        render: function(data, type, row) {
                            return `
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary edit-user-btn" 
                                            data-user='${JSON.stringify(row)}' title="수정">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-user-btn" 
                                            data-id="${row.id}" title="삭제">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ]
            });

            // Load users data from API
            loadUsersData();

            async function loadUsersData() {
                try {
                    const response = await axios.get('/api/users');
                    usersData = response.data;
                    usersTable.clear().rows.add(usersData).draw();
                    console.log('Users data loaded successfully');
                } catch (error) {
                    console.error('Error loading users data:', error);
                    alert('사용자 데이터를 불러오는데 실패했습니다.');
                }
            }

            // Register new user
            $('#registerUserBtn').click(async function() {
                const formData = {
                    username: $('#newUserId').val(),
                    name: $('#newUserName').val(),
                    password: $('#newUserPassword').val(),
                    confirmPassword: $('#confirmPassword').val(),
                    role: $('#newUserRole').val(),
                    notes: $('#newUserNotes').val()
                };

                // Basic validation
                if (!formData.username || formData.username.length < 4) {
                    alert('아이디는 4자 이상이어야 합니다.');
                    return;
                }

                if (!formData.name) {
                    alert('이름을 입력해주세요.');
                    return;
                }

                if (formData.password !== formData.confirmPassword) {
                    alert('비밀번호가 일치하지 않습니다.');
                    return;
                }

                if (formData.password.length < 8) {
                    alert('비밀번호는 8자 이상이어야 합니다.');
                    return;
                }

                if (!formData.role) {
                    alert('권한을 선택해주세요.');
                    return;
                }

                try {
                    const response = await axios.post('/api/users', formData);
                    if (response.data.success) {
                        $('#registerModal').modal('hide');
                        $('#registerForm')[0].reset();
                        alert(response.data.message);
                        // Reload data from server
                        loadUsersData();
                    }
                } catch (error) {
                    console.error('Error creating user:', error);
                    alert('사용자 등록 중 오류가 발생했습니다.');
                }
            });

            // Edit user
            $(document).on('click', '.edit-user-btn', function() {
                const userData = JSON.parse($(this).attr('data-user'));
                currentEditingUser = userData;
                
                $('#editUserId').val(userData.id);
                $('#editUserIdDisplay').val(userData.username);
                $('#editUserName').val(userData.name);
                $('#editUserRole').val(userData.role);
                $('#editUserNotes').val(userData.notes);
                
                $('#editModal').modal('show');
            });

            // Save user changes
            $('#saveChangesBtn').click(function() {
                if (!currentEditingUser) return;

                const activeTab = $('.tab-pane.active').attr('id');
                
                if (activeTab === 'userInfoTab') {
                    const formData = {
                        name: $('#editUserName').val(),
                        role: $('#editUserRole').val(),
                        notes: $('#editUserNotes').val()
                    };

                    if (!formData.name) {
                        alert('이름을 입력해주세요.');
                        return;
                    }

                    // Update via API
                    try {
                        const response = await axios.put(`/api/users/${currentEditingUser.id}`, formData);
                        if (response.data.success) {
                            $('#editModal').modal('hide');
                            alert(response.data.message);
                            loadUsersData();
                        }
                    } catch (error) {
                        console.error('Error updating user:', error);
                        alert('사용자 정보 수정 중 오류가 발생했습니다.');
                    }
                    
                } else if (activeTab === 'passwordTab') {
                    const newPassword = $('#newPassword').val();
                    const confirmPassword = $('#confirmNewPassword').val();

                    if (newPassword !== confirmPassword) {
                        alert('비밀번호가 일치하지 않습니다.');
                        return;
                    }

                    if (newPassword.length < 8) {
                        alert('비밀번호는 8자 이상이어야 합니다.');
                        return;
                    }

                    $('#editModal').modal('hide');
                    $('#changePasswordForm')[0].reset();
                    alert('비밀번호가 성공적으로 변경되었습니다.');
                }
            });

            // Delete user
            $(document).on('click', '.delete-user-btn', async function() {
                const userId = parseInt($(this).data('id'));
                
                if (confirm('정말로 이 사용자를 삭제하시겠습니까?\n삭제된 데이터는 복구할 수 없습니다.')) {
                    try {
                        const response = await axios.delete(`/api/users/${userId}`);
                        if (response.data.success) {
                            alert(response.data.message);
                            loadUsersData();
                        }
                    } catch (error) {
                        console.error('Error deleting user:', error);
                        alert('사용자 삭제 중 오류가 발생했습니다.');
                    }
                }
            });

            // ID duplicate check
            $('#checkIdBtn').click(function() {
                const userId = $('#newUserId').val();
                if (!userId) {
                    alert('아이디를 입력해주세요.');
                    return;
                }

                // Check if username already exists in loaded data
                const isExisting = usersData.some(user => user.username.toLowerCase() === userId.toLowerCase());
                
                if (isExisting) {
                    alert('이미 사용 중인 아이디입니다.');
                } else {
                    alert('사용 가능한 아이디입니다.');
                }
            });

            // Reset forms when modals are hidden
            $('#registerModal').on('hidden.bs.modal', function() {
                $('#registerForm')[0].reset();
            });

            $('#editModal').on('hidden.bs.modal', function() {
                $('#editUserForm')[0].reset();
                $('#changePasswordForm')[0].reset();
                currentEditingUser = null;
                $('.nav-link[data-bs-target="#userInfoTab"]').tab('show');
            });

            // Sidebar toggle
            $('.sidebar-toggle').click(function() {
                $('.sidebar').toggleClass('active');
            });
        });
    </script>
</body>
</html>
