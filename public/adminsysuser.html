<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시스템관리자 | simpleEye DCIM</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Custom CSS -->
    <link href="css/themes.css" rel="stylesheet">
    <link href="css/modern-admin.css" rel="stylesheet">
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle-container">
        <button id="themeToggle" class="theme-toggle-btn" title="테마 변경">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-logo">
                    <svg width="40" height="40" viewBox="0 0 40 40" class="logo-icon">
                        <defs>
                            <linearGradient id="sidebarLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:var(--primary-color)"/>
                                <stop offset="100%" style="stop-color:var(--secondary-color)"/>
                            </linearGradient>
                        </defs>
                        <circle cx="10" cy="10" r="3" fill="url(#sidebarLogoGradient)"/>
                        <circle cx="20" cy="10" r="3" fill="url(#sidebarLogoGradient)" opacity="0.7"/>
                        <circle cx="30" cy="10" r="3" fill="url(#sidebarLogoGradient)" opacity="0.5"/>
                        <rect x="5" y="20" width="30" height="2" rx="1" fill="url(#sidebarLogoGradient)"/>
                        <text x="8" y="35" font-family="Arial, sans-serif" font-size="8" fill="url(#sidebarLogoGradient)" font-weight="bold">Eye</text>
                    </svg>
                    <span class="logo-text">simpleEye</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">시스템 관리</div>
                    <div class="nav-item">
                        <a href="adminsysuser.html" class="nav-link active">
                            <i class="fas fa-users"></i>
                            <span class="nav-text">시스템관리자</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="alarmConfig.html" class="nav-link">
                            <i class="fas fa-bell"></i>
                            <span class="nav-text">알람 설정</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">모니터링</div>
                    <div class="nav-item">
                        <a href="adminPortUsage.html" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            <span class="nav-text">포트 사용량</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link">
                            <i class="fas fa-server"></i>
                            <span class="nav-text">시스템 상태</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">보고서</div>
                    <div class="nav-item">
                        <a href="usageReport.html" class="nav-link">
                            <i class="fas fa-file-alt"></i>
                            <span class="nav-text">사용량 보고서</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="queryBuilder.html" class="nav-link">
                            <i class="fas fa-search"></i>
                            <span class="nav-text">쿼리 빌더</span>
                        </a>
                    </div>
                </div>
            </nav>

            <div class="sidebar-user">
                <div class="user-profile">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name">관리자</div>
                        <div class="user-role">시스템 관리자</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-content">
                    <div class="header-left">
                        <button class="sidebar-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <h1 class="page-title">시스템관리자</h1>
                            <nav class="breadcrumb-custom">
                                <a href="#">simpleEye</a>
                                <i class="fas fa-chevron-right"></i>
                                <span>시스템 설정</span>
                                <i class="fas fa-chevron-right"></i>
                                <strong>시스템관리자</strong>
                            </nav>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn has-notification" title="알림">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="header-btn" title="설정">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="header-btn" title="로그아웃">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="modern-card">
                            <div class="card-body-modern text-center">
                                <div class="stat-icon mb-3">
                                    <i class="fas fa-users text-gradient" style="font-size: 2.5rem;"></i>
                                </div>
                                <h3 class="mb-1" id="totalUsers">-</h3>
                                <p class="text-muted mb-0">전체 사용자</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="modern-card">
                            <div class="card-body-modern text-center">
                                <div class="stat-icon mb-3">
                                    <i class="fas fa-user-shield text-gradient" style="font-size: 2.5rem;"></i>
                                </div>
                                <h3 class="mb-1" id="activeAdmins">-</h3>
                                <p class="text-muted mb-0">활성 관리자</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="modern-card">
                            <div class="card-body-modern text-center">
                                <div class="stat-icon mb-3">
                                    <i class="fas fa-clock text-gradient" style="font-size: 2.5rem;"></i>
                                </div>
                                <h3 class="mb-1" id="lastLogin">-</h3>
                                <p class="text-muted mb-0">최근 로그인</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="modern-card">
                            <div class="card-body-modern text-center">
                                <div class="stat-icon mb-3">
                                    <i class="fas fa-security text-gradient" style="font-size: 2.5rem;"></i>
                                </div>
                                <h3 class="mb-1" id="securityLevel">높음</h3>
                                <p class="text-muted mb-0">보안 수준</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Table -->
                <div class="modern-card">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">관리자 목록</h3>
                        <button class="btn btn-primary-modern" data-bs-toggle="modal" data-bs-target="#registerModal">
                            <i class="fas fa-plus"></i>
                            계정 등록
                        </button>
                    </div>
                    <div class="card-body-modern">
                        <div class="table-container">
                            <table id="usersTable" class="table table-modern" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>아이디</th>
                                        <th>이름</th>
                                        <th>권한</th>
                                        <th>이메일</th>
                                        <th>가입일</th>
                                        <th>상태</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Register Modal -->
    <div class="modal fade modal-modern" id="registerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">새 계정 등록</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">아이디</label>
                                    <div class="input-group">
                                        <input type="text" id="newUserId" class="form-control form-control-modern" required>
                                        <button type="button" class="btn btn-secondary-modern btn-sm-modern" id="checkIdBtn">중복확인</button>
                                    </div>
                                    <div class="form-text">4-20자의 영문, 숫자만 사용 가능</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">이름</label>
                                    <input type="text" id="newUserName" class="form-control form-control-modern" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">비밀번호</label>
                                    <input type="password" id="newUserPassword" class="form-control form-control-modern" required>
                                    <div class="form-text">8자 이상, 영문, 숫자, 특수문자 포함</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">비밀번호 확인</label>
                                    <input type="password" id="confirmPassword" class="form-control form-control-modern" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">권한</label>
                                    <select id="newUserRole" class="form-control form-control-modern" required>
                                        <option value="">권한을 선택하세요</option>
                                        <option value="최고관리자">최고관리자</option>
                                        <option value="관리자">관리자</option>
                                        <option value="운영자">운영자</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label-modern">이메일</label>
                                    <input type="email" id="newUserEmail" class="form-control form-control-modern" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary-modern" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary-modern" id="registerUserBtn">
                        <i class="fas fa-save"></i>
                        등록
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade modal-modern" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">사용자 정보 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs mb-4">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#userInfoTab">기본 정보</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#passwordTab">비밀번호 변경</button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="userInfoTab">
                            <form id="editUserForm">
                                <input type="hidden" id="editUserId">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label-modern">아이디</label>
                                            <input type="text" id="editUserIdDisplay" class="form-control form-control-modern" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label-modern">이름</label>
                                            <input type="text" id="editUserName" class="form-control form-control-modern" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label-modern">권한</label>
                                            <select id="editUserRole" class="form-control form-control-modern" required>
                                                <option value="최고관리자">최고관리자</option>
                                                <option value="관리자">관리자</option>
                                                <option value="운영자">운영자</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label-modern">이메일</label>
                                            <input type="email" id="editUserEmail" class="form-control form-control-modern" required>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="passwordTab">
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label class="form-label-modern">새 비밀번호</label>
                                    <input type="password" id="newPassword" class="form-control form-control-modern" required>
                                    <div class="form-text">8자 이상, 영문, 숫자, 특수문자 포함</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label-modern">새 비밀번호 확인</label>
                                    <input type="password" id="confirmNewPassword" class="form-control form-control-modern" required>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary-modern" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary-modern" id="saveChangesBtn">
                        <i class="fas fa-save"></i>
                        저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    
    <script src="js/theme-manager.js"></script>
    <script src="js/admin-common.js"></script>
    <script src="js/toast-notifications.js"></script>

    <script>
        $(document).ready(function() {
            let usersTable;
            let currentEditingUser = null;

            // Initialize DataTable
            usersTable = $('#usersTable').DataTable({
                ...window.DataTableDefaults,
                ajax: {
                    url: '/api/users',
                    dataSrc: ''
                },
                columns: [
                    { data: 'username' },
                    { data: 'name' },
                    { data: 'role' },
                    { data: 'email' },
                    { 
                        data: 'joinDate',
                        render: function(data) {
                            return window.AdminUtils.formatDate(data);
                        }
                    },
                    {
                        data: null,
                        render: function(data, type, row) {
                            const isActive = Math.random() > 0.3; // Random status for demo
                            return isActive 
                                ? '<span class="status-badge status-active">활성</span>'
                                : '<span class="status-badge status-inactive">비활성</span>';
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return `
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm-modern btn-secondary-modern edit-user-btn" 
                                            data-user='${JSON.stringify(row)}' title="수정">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm-modern btn-danger-modern delete-user-btn" 
                                            data-id="${row.id}" title="삭제">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ],
                drawCallback: function() {
                    updateStatistics();
                }
            });

            // Update statistics
            function updateStatistics() {
                const data = usersTable.data();
                $('#totalUsers').text(data.length);
                $('#activeAdmins').text(data.length);
                $('#lastLogin').text('오늘');
            }

            // Register new user
            $('#registerUserBtn').click(async function() {
                const formData = {
                    username: $('#newUserId').val(),
                    name: $('#newUserName').val(),
                    password: $('#newUserPassword').val(),
                    confirmPassword: $('#confirmPassword').val(),
                    role: $('#newUserRole').val(),
                    email: $('#newUserEmail').val()
                };

                // Validation
                if (!validateUserForm(formData)) {
                    return;
                }

                try {
                    $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 등록 중...');
                    
                    await window.AdminUtils.apiRequest('/users', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });

                    window.ToastNotifications.success('새 사용자가 성공적으로 등록되었습니다.');
                    $('#registerModal').modal('hide');
                    $('#registerForm')[0].reset();
                    usersTable.ajax.reload();
                    
                } catch (error) {
                    window.ToastNotifications.error('사용자 등록에 실패했습니다.');
                } finally {
                    $(this).prop('disabled', false).html('<i class="fas fa-save"></i> 등록');
                }
            });

            // Edit user
            $(document).on('click', '.edit-user-btn', function() {
                const userData = JSON.parse($(this).attr('data-user'));
                currentEditingUser = userData;
                
                $('#editUserId').val(userData.id);
                $('#editUserIdDisplay').val(userData.username);
                $('#editUserName').val(userData.name);
                $('#editUserRole').val(userData.role);
                $('#editUserEmail').val(userData.email);
                
                $('#editModal').modal('show');
            });

            // Save user changes
            $('#saveChangesBtn').click(async function() {
                if (!currentEditingUser) return;

                const activeTab = $('.tab-pane.active').attr('id');
                
                if (activeTab === 'userInfoTab') {
                    const formData = {
                        name: $('#editUserName').val(),
                        role: $('#editUserRole').val(),
                        email: $('#editUserEmail').val()
                    };

                    if (!window.AdminUtils.isValidEmail(formData.email)) {
                        window.ToastNotifications.warning('올바른 이메일 형식을 입력해주세요.');
                        return;
                    }

                    try {
                        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 저장 중...');
                        
                        await window.AdminUtils.apiRequest(`/users/${currentEditingUser.id}`, {
                            method: 'PUT',
                            body: JSON.stringify(formData)
                        });

                        window.ToastNotifications.success('사용자 정보가 성공적으로 수정되었습니다.');
                        $('#editModal').modal('hide');
                        usersTable.ajax.reload();
                        
                    } catch (error) {
                        window.ToastNotifications.error('사용자 정보 수정에 실패했습니다.');
                    } finally {
                        $(this).prop('disabled', false).html('<i class="fas fa-save"></i> 저장');
                    }
                    
                } else if (activeTab === 'passwordTab') {
                    const newPassword = $('#newPassword').val();
                    const confirmPassword = $('#confirmNewPassword').val();

                    if (newPassword !== confirmPassword) {
                        window.ToastNotifications.warning('비밀번호가 일치하지 않습니다.');
                        return;
                    }

                    if (newPassword.length < 8) {
                        window.ToastNotifications.warning('비밀번호는 8자 이상이어야 합니다.');
                        return;
                    }

                    try {
                        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 저장 중...');
                        
                        await window.AdminUtils.apiRequest(`/users/${currentEditingUser.id}/password`, {
                            method: 'PUT',
                            body: JSON.stringify({ password: newPassword })
                        });

                        window.ToastNotifications.success('비밀번호가 성공적으로 변경되었습니다.');
                        $('#editModal').modal('hide');
                        $('#changePasswordForm')[0].reset();
                        
                    } catch (error) {
                        window.ToastNotifications.error('비밀번호 변경에 실패했습니다.');
                    } finally {
                        $(this).prop('disabled', false).html('<i class="fas fa-save"></i> 저장');
                    }
                }
            });

            // Delete user
            $(document).on('click', '.delete-user-btn', async function() {
                const userId = $(this).data('id');
                
                const confirmed = await window.AdminUtils.confirm(
                    '정말로 이 사용자를 삭제하시겠습니까?\n삭제된 데이터는 복구할 수 없습니다.',
                    '사용자 삭제'
                );

                if (confirmed) {
                    try {
                        await window.AdminUtils.apiRequest(`/users/${userId}`, {
                            method: 'DELETE'
                        });

                        window.ToastNotifications.success('사용자가 성공적으로 삭제되었습니다.');
                        usersTable.ajax.reload();
                        
                    } catch (error) {
                        window.ToastNotifications.error('사용자 삭제에 실패했습니다.');
                    }
                }
            });

            // ID duplicate check
            $('#checkIdBtn').click(async function() {
                const userId = $('#newUserId').val();
                if (!userId) {
                    window.ToastNotifications.warning('아이디를 입력해주세요.');
                    return;
                }

                // Simple validation for demo
                const isAvailable = !['admin', 'root', 'administrator'].includes(userId.toLowerCase());
                
                if (isAvailable) {
                    window.ToastNotifications.success('사용 가능한 아이디입니다.');
                } else {
                    window.ToastNotifications.warning('이미 사용 중인 아이디입니다.');
                }
            });

            // Form validation
            function validateUserForm(data) {
                if (!data.username || data.username.length < 4) {
                    window.ToastNotifications.warning('아이디는 4자 이상이어야 합니다.');
                    return false;
                }

                if (!data.name) {
                    window.ToastNotifications.warning('이름을 입력해주세요.');
                    return false;
                }

                if (data.password !== data.confirmPassword) {
                    window.ToastNotifications.warning('비밀번호가 일치하지 않습니다.');
                    return false;
                }

                if (data.password.length < 8) {
                    window.ToastNotifications.warning('비밀번호는 8자 이상이어야 합니다.');
                    return false;
                }

                if (!window.AdminUtils.isValidEmail(data.email)) {
                    window.ToastNotifications.warning('올바른 이메일 형식을 입력해주세요.');
                    return false;
                }

                if (!data.role) {
                    window.ToastNotifications.warning('권한을 선택해주세요.');
                    return false;
                }

                return true;
            }

            // Reset forms when modals are hidden
            $('#registerModal').on('hidden.bs.modal', function() {
                $('#registerForm')[0].reset();
            });

            $('#editModal').on('hidden.bs.modal', function() {
                $('#editUserForm')[0].reset();
                $('#changePasswordForm')[0].reset();
                currentEditingUser = null;
                $('.nav-link[data-bs-target="#userInfoTab"]').tab('show');
            });
        });
    </script>
</body>
</html>
