<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전력조회 | simpleEye DCIM</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Custom CSS -->
    <link href="css/themes.css" rel="stylesheet">
    <link href="css/modern-admin.css" rel="stylesheet">
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle-container">
        <button id="themeToggle" class="theme-toggle-btn" title="테마 변경">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-logo">
                    <svg width="40" height="40" viewBox="0 0 40 40" class="logo-icon">
                        <defs>
                            <linearGradient id="sidebarLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:var(--primary-color)"/>
                                <stop offset="100%" style="stop-color:var(--secondary-color)"/>
                            </linearGradient>
                        </defs>
                        <circle cx="10" cy="10" r="3" fill="url(#sidebarLogoGradient)"/>
                        <circle cx="20" cy="10" r="3" fill="url(#sidebarLogoGradient)" opacity="0.7"/>
                        <circle cx="30" cy="10" r="3" fill="url(#sidebarLogoGradient)" opacity="0.5"/>
                        <rect x="5" y="20" width="30" height="2" rx="1" fill="url(#sidebarLogoGradient)"/>
                        <text x="8" y="35" font-family="Arial, sans-serif" font-size="8" fill="url(#sidebarLogoGradient)" font-weight="bold">Eye</text>
                    </svg>
                    <span class="logo-text">죽전 퍼시픽써니 DC</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">조회 보고서</div>
                    <div class="nav-item">
                        <a href="powerInquiry.html" class="nav-link active">
                            <i class="fas fa-bolt"></i>
                            <span class="nav-text">전력조회</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="faultInquiry.html" class="nav-link">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="nav-text">장애조회</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">설정</div>
                    <div class="nav-item">
                        <a href="alarmConfig.html" class="nav-link">
                            <i class="fas fa-bell"></i>
                            <span class="nav-text">장애 설정</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="alarmLevelConfig.html" class="nav-link">
                            <i class="fas fa-layer-group"></i>
                            <span class="nav-text">장애등급 설정</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">사용자관리</div>
                    <div class="nav-item">
                        <a href="adminsysuser.html" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span class="nav-text">사용자관리</span>
                        </a>
                    </div>
                </div>
            </nav>

            <div class="sidebar-user">
                <div class="user-profile">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name">관리자</div>
                        <div class="user-role">시스템 관리자</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-content">
                    <div class="header-left">
                        <button class="sidebar-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <h1 class="page-title">전력조회</h1>
                            <nav class="breadcrumb-custom">
                                <a href="#">simpleEye</a>
                                <i class="fas fa-chevron-right"></i>
                                <span>조회 보고서</span>
                                <i class="fas fa-chevron-right"></i>
                                <strong>전력조회</strong>
                            </nav>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn" id="refreshData" title="데이터 새로고침">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="header-btn" id="exportData" title="데이터 내보내기">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="header-btn has-notification" title="알림">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="header-btn" title="설정">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="header-btn" title="로그아웃">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Filter Controls -->
                <div class="modern-card mb-4">
                    <div class="card-body-modern">
                        <div class="row g-3">
                            <!-- 첫 번째 행: 층/DCU/BUSWAY/라인 -->
                            <div class="col-md-3">
                                <label class="form-label-modern">층</label>
                                <select class="form-control form-control-modern" id="floorSelect">
                                    <option value="">전체 층</option>
                                    <option value="B2">지하 2층</option>
                                    <option value="B1">지하 1층</option>
                                    <option value="1F">1층</option>
                                    <option value="2F">2층</option>
                                    <option value="3F">3층</option>
                                    <option value="4F">4층</option>
                                    <option value="5F">5층</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-modern">DCU</label>
                                <select class="form-control form-control-modern" id="dcuSelect">
                                    <option value="">전체 DCU</option>
                                    <option value="DCU-001">DCU-001</option>
                                    <option value="DCU-002">DCU-002</option>
                                    <option value="DCU-003">DCU-003</option>
                                    <option value="DCU-004">DCU-004</option>
                                    <option value="DCU-005">DCU-005</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-modern">BUSWAY</label>
                                <select class="form-control form-control-modern" id="buswaySelect">
                                    <option value="">전체 BUSWAY</option>
                                    <option value="BW-A">BUSWAY-A</option>
                                    <option value="BW-B">BUSWAY-B</option>
                                    <option value="BW-C">BUSWAY-C</option>
                                    <option value="BW-D">BUSWAY-D</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-modern">라인</label>
                                <select class="form-control form-control-modern" id="lineSelect">
                                    <option value="">전체 라인</option>
                                    <option value="L1">라인 1</option>
                                    <option value="L2">라인 2</option>
                                    <option value="L3">라인 3</option>
                                    <option value="L4">라인 4</option>
                                </select>
                            </div>
                            
                            <!-- 두 번째 행: 날짜 범위와 시간 -->
                            <div class="col-md-3">
                                <label class="form-label-modern">시작 날짜</label>
                                <input type="date" class="form-control form-control-modern" id="startDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-modern">시작 시간</label>
                                <input type="time" class="form-control form-control-modern" id="startTime" value="00:00">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-modern">종료 날짜</label>
                                <input type="date" class="form-control form-control-modern" id="endDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-modern">종료 시간</label>
                                <input type="time" class="form-control form-control-modern" id="endTime" value="23:59">
                            </div>
                            
                            <!-- 세 번째 행: 라디오 버튼과 조회 버튼 -->
                            <div class="col-md-6">
                                <label class="form-label-modern">조회 항목</label>
                                <div class="d-flex gap-4 mt-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="powerType" id="voltageRadio" value="voltage" checked>
                                        <label class="form-check-label" for="voltageRadio">
                                            전압 (V)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="powerType" id="currentRadio" value="current">
                                        <label class="form-check-label" for="currentRadio">
                                            전류 (A)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="powerType" id="powerRadio" value="power">
                                        <label class="form-check-label" for="powerRadio">
                                            전력량 (kWh)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="d-flex gap-2 w-100">
                                    <button class="btn btn-primary-modern flex-fill" id="searchPowerData">
                                        <i class="fas fa-search"></i>
                                        조회
                                    </button>
                                    <button class="btn btn-secondary-modern" id="resetFilter">
                                        <i class="fas fa-undo"></i>
                                        초기화
                                    </button>
                                    <button class="btn btn-success-modern" id="exportPowerData">
                                        <i class="fas fa-file-excel"></i>
                                        Excel
                                    </button>
                                    <button class="btn btn-info-modern" id="exportCsvData">
                                        <i class="fas fa-file-csv"></i>
                                        CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="modern-card mb-4">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">전력 트렌드 차트</h3>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-secondary-modern" id="chartFullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-secondary-modern dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" id="chartSettings"><i class="fas fa-sliders-h me-2"></i>차트 설정</a></li>
                                    <li><a class="dropdown-item" href="#" id="exportChartImage"><i class="fas fa-image me-2"></i>이미지로 저장</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body-modern">
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="powerTrendChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="modern-card">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">전력 데이터 상세</h3>
                        <div class="d-flex gap-2">
                            <span class="badge bg-info" id="dataCount">총 0건</span>
                        </div>
                    </div>
                    <div class="card-body-modern">
                        <div class="table-container">
                            <table id="powerDataTable" class="table table-modern" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>시간</th>
                                        <th>랩명</th>
                                        <th>층</th>
                                        <th>평균 전류수</th>
                                        <th>계측수</th>
                                        <th>미래량 전류수</th>
                                        <th>사용률(%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label-modern mb-0">페이지당 항목:</label>
                                <select class="form-select form-select-sm" id="pageSize" style="width: auto;">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <nav aria-label="Table pagination">
                                <ul class="pagination pagination-sm mb-0" id="tablePagination">
                                    <!-- Pagination will be generated by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="js/theme-manager.js"></script>
    <script src="js/admin-common.js"></script>
    <script src="js/toast-notifications.js"></script>

    <script>
        $(document).ready(function() {
            let powerDataTable;
            let powerTrendChart;
            let currentPowerType = 'voltage';

            // Set default dates (last 7 days)
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            $('#startDate').val(lastWeek.toISOString().split('T')[0]);
            $('#endDate').val(today.toISOString().split('T')[0]);

            // Initialize DataTable
            powerDataTable = $('#powerDataTable').DataTable({
                processing: true,
                serverSide: false,
                responsive: true,
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/ko.json"
                },
                data: generateMockPowerData(),
                columns: [
                    { 
                        data: 'timestamp',
                        render: function(data) {
                            return new Date(data).toLocaleString('ko-KR');
                        }
                    },
                    { data: 'labName' },
                    { data: 'floor' },
                    { 
                        data: 'avgCurrent',
                        render: function(data) {
                            return data.toFixed(2);
                        }
                    },
                    { 
                        data: 'measurement',
                        render: function(data) {
                            return data.toFixed(2);
                        }
                    },
                    { 
                        data: 'futureCurrent',
                        render: function(data) {
                            return data.toFixed(2);
                        }
                    },
                    { 
                        data: 'usage',
                        render: function(data) {
                            const color = data > 80 ? 'danger' : data > 60 ? 'warning' : 'success';
                            return `<span class="text-${color} fw-bold">${data.toFixed(1)}</span>`;
                        }
                    }
                ],
                order: [[0, 'desc']],
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
            });

            // Initialize Chart
            initializePowerChart();

            // Generate mock power data
            function generateMockPowerData() {
                const data = [];
                const labNames = ['aaaa', 'bbbb', 'cccc', 'dddd', 'eeee'];
                const floors = ['1111', '2222', '3333', '4444', '5555'];
                const startDate = new Date($('#startDate').val() || lastWeek);
                const endDate = new Date($('#endDate').val() || today);
                
                // Generate hourly data points
                for (let d = new Date(startDate); d <= endDate; d.setHours(d.getHours() + 1)) {
                    const randomLab = Math.floor(Math.random() * labNames.length);
                    data.push({
                        timestamp: new Date(d).toISOString(),
                        labName: labNames[randomLab],
                        floor: floors[randomLab],
                        avgCurrent: Math.random() * 150 + 50,
                        measurement: Math.random() * 200 + 100,
                        futureCurrent: Math.random() * 50 + 10,
                        usage: Math.random() * 40 + 60
                    });
                }
                
                return data.slice(-100); // Limit to last 100 records for performance
            }

            // Initialize power trend chart
            function initializePowerChart() {
                const ctx = document.getElementById('powerTrendChart').getContext('2d');
                powerTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '전압 (V)',
                            data: [],
                            borderColor: 'rgb(139, 92, 246)',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    displayFormats: {
                                        hour: 'MM-dd HH:mm'
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(1);
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    color: '#fff'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgb(139, 92, 246)',
                                borderWidth: 1
                            }
                        }
                    }
                });
                
                updateChart();
            }

            // Update chart based on selected power type
            function updateChart() {
                const data = powerDataTable.data().toArray();
                const labels = [];
                const values = [];
                
                // Sort by timestamp
                data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                data.forEach(item => {
                    labels.push(new Date(item.timestamp));
                    switch(currentPowerType) {
                        case 'voltage':
                            values.push(item.avgCurrent * 2.2); // Mock voltage calculation
                            break;
                        case 'current':
                            values.push(item.avgCurrent);
                            break;
                        case 'power':
                            values.push(item.measurement / 10); // Mock power calculation
                            break;
                    }
                });

                const powerTypeLabels = {
                    'voltage': '전압 (V)',
                    'current': '전류 (A)',
                    'power': '전력량 (kWh)'
                };

                powerTrendChart.data.labels = labels;
                powerTrendChart.data.datasets[0].label = powerTypeLabels[currentPowerType];
                powerTrendChart.data.datasets[0].data = values;
                powerTrendChart.update('active');
            }

            // Radio button change event
            $('input[name="powerType"]').change(function() {
                currentPowerType = $(this).val();
                updateChart();
            });

            // Search button
            $('#searchPowerData').click(function() {
                const startDate = $('#startDate').val();
                const endDate = $('#endDate').val();
                const floor = $('#floorSelect').val();
                const dcu = $('#dcuSelect').val();
                const busway = $('#buswaySelect').val();
                const line = $('#lineSelect').val();
                
                if (!startDate || !endDate) {
                    window.ToastNotifications.warning('시작 날짜와 종료 날짜를 선택해주세요.');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    window.ToastNotifications.error('시작 날짜는 종료 날짜보다 이전이어야 합니다.');
                    return;
                }

                // Show loading
                const btn = $(this);
                const originalText = btn.html();
                btn.html('<i class="fas fa-spinner fa-spin"></i> 조회 중...');
                btn.prop('disabled', true);

                // Simulate API call
                setTimeout(() => {
                    const newData = generateMockPowerData();
                    powerDataTable.clear();
                    powerDataTable.rows.add(newData);
                    powerDataTable.draw();
                    
                    updateChart();
                    updateDataCount(newData.length);
                    
                    btn.html(originalText);
                    btn.prop('disabled', false);
                    
                    window.ToastNotifications.success(`${newData.length}건의 데이터를 조회했습니다.`);
                }, 1500);
            });

            // Reset filter
            $('#resetFilter').click(function() {
                $('#floorSelect, #dcuSelect, #buswaySelect, #lineSelect').val('');
                $('#startDate').val(lastWeek.toISOString().split('T')[0]);
                $('#endDate').val(today.toISOString().split('T')[0]);
                $('#startTime').val('00:00');
                $('#endTime').val('23:59');
                $('input[name="powerType"][value="voltage"]').prop('checked', true);
                currentPowerType = 'voltage';
                
                window.ToastNotifications.info('필터가 초기화되었습니다.');
            });

            // Export functions
            $('#exportPowerData').click(function() {
                window.ToastNotifications.info('Excel 파일을 생성하는 중입니다...');
                setTimeout(() => {
                    window.ToastNotifications.success('Excel 파일이 다운로드되었습니다.');
                }, 2000);
            });

            $('#exportCsvData').click(function() {
                window.ToastNotifications.info('CSV 파일을 생성하는 중입니다...');
                setTimeout(() => {
                    window.ToastNotifications.success('CSV 파일이 다운로드되었습니다.');
                }, 2000);
            });

            // Chart controls
            $('#chartFullscreen').click(function() {
                if (powerTrendChart.canvas.requestFullscreen) {
                    powerTrendChart.canvas.requestFullscreen();
                }
            });

            $('#exportChartImage').click(function() {
                const url = powerTrendChart.toBase64Image();
                const link = document.createElement('a');
                link.download = `power-trend-${new Date().toISOString().split('T')[0]}.png`;
                link.href = url;
                link.click();
                window.ToastNotifications.success('차트 이미지가 저장되었습니다.');
            });

            // Update data count
            function updateDataCount(count) {
                $('#dataCount').text(`총 ${count}건`);
            }

            // Initialize data count
            updateDataCount(powerDataTable.data().length);

            // Page size change
            $('#pageSize').change(function() {
                powerDataTable.page.len(parseInt($(this).val())).draw();
            });

            // Auto refresh every 5 minutes
            setInterval(() => {
                if ($('#autoRefresh').is(':checked')) {
                    $('#searchPowerData').click();
                }
            }, 300000);
        });
    </script>
</body>
</html>
