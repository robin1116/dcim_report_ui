<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전력조회 | simpleEye DCIM</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <!-- Custom CSS -->
    <link href="css/themes.css" rel="stylesheet">
    <link href="css/modern-admin.css" rel="stylesheet">
    
    <style>
        /* Custom column widths for compact layout */
        .col-md-1-5 {
            flex: 0 0 auto;
            width: 12%;
        }
        
        @media (max-width: 768px) {
            .col-md-1-5 {
                width: 50%;
            }
        }
        
        /* Compact form controls */
        .form-control-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .form-check-sm .form-check-input {
            margin-top: 0.125em;
        }
        
        .form-check-sm .form-check-label {
            font-size: 0.875rem;
        }
        
        /* Compact card body */
        .card-body-modern.py-3 {
            padding: 1rem 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle-container">
        <button id="themeToggle" class="theme-toggle-btn" title="테마 변경">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-logo">
                    <svg width="40" height="40" viewBox="0 0 40 40" class="logo-icon">
                        <defs>
                            <linearGradient id="sidebarLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:var(--primary-color)"/>
                                <stop offset="100%" style="stop-color:var(--secondary-color)"/>
                            </linearGradient>
                        </defs>
                        <circle cx="10" cy="10" r="3" fill="url(#sidebarLogoGradient)"/>
                        <circle cx="20" cy="10" r="3" fill="url(#sidebarLogoGradient)" opacity="0.7"/>
                        <circle cx="30" cy="10" r="3" fill="url(#sidebarLogoGradient)" opacity="0.5"/>
                        <rect x="5" y="20" width="30" height="2" rx="1" fill="url(#sidebarLogoGradient)"/>
                        <text x="8" y="35" font-family="Arial, sans-serif" font-size="8" fill="url(#sidebarLogoGradient)" font-weight="bold">Eye</text>
                    </svg>
                    <span class="logo-text">죽전 퍼시픽써니 DC</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">조회 보고서</div>
                    <div class="nav-item">
                        <a href="powerInquiry.html" class="nav-link active">
                            <i class="fas fa-bolt"></i>
                            <span class="nav-text">전력조회</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="faultInquiry.html" class="nav-link">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="nav-text">장애조회</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">설정</div>
                    <div class="nav-item">
                        <a href="alarmConfig.html" class="nav-link">
                            <i class="fas fa-bell"></i>
                            <span class="nav-text">장애 설정</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="alarmLevelConfig.html" class="nav-link">
                            <i class="fas fa-layer-group"></i>
                            <span class="nav-text">장애등급 설정</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">사용자관리</div>
                    <div class="nav-item">
                        <a href="adminsysuser.html" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span class="nav-text">사용자관리</span>
                        </a>
                    </div>
                </div>
            </nav>

            <div class="sidebar-user">
                <div class="user-profile">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name">관리자</div>
                        <div class="user-role">시스템 관리자</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-content">
                    <div class="header-left">
                        <button class="sidebar-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <h1 class="page-title">전력조회</h1>
                            <nav class="breadcrumb-custom">
                                <a href="#">simpleEye</a>
                                <i class="fas fa-chevron-right"></i>
                                <span>조회 보고서</span>
                                <i class="fas fa-chevron-right"></i>
                                <strong>전력조회</strong>
                            </nav>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn" id="refreshData" title="데이터 새로고침">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="header-btn" id="exportData" title="데이터 내보내기">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="header-btn has-notification" title="알림">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="header-btn" title="설정">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="header-btn" title="로그아웃">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Filter Controls -->
                <div class="filter-container mb-4">
                    <!-- 첫 번째 행: 드롭다운 선택 -->
                    <div class="row g-2 mb-3">
                        <div class="col-3">
                            <select class="form-select form-select-light" id="totalFilter" style="border-radius: 25px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #666;">
                                <option value="all">전체 중</option>
                                <option value="zone1">Zone 1</option>
                                <option value="zone2">Zone 2</option>
                                <option value="zone3">Zone 3</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <select class="form-select form-select-light" id="dcuFilter" style="border-radius: 25px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #666;">
                                <option value="all">전체 DCU</option>
                                <option value="dcu1">DCU-001</option>
                                <option value="dcu2">DCU-002</option>
                                <option value="dcu3">DCU-003</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <select class="form-select form-select-light" id="buswayFilter" style="border-radius: 25px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #666;">
                                <option value="all">전체 BUSWAY</option>
                                <option value="busway1">BUSWAY-A</option>
                                <option value="busway2">BUSWAY-B</option>
                                <option value="busway3">BUSWAY-C</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <select class="form-select form-select-light" id="lineFilter" style="border-radius: 25px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #666;">
                                <option value="all">전체 라인</option>
                                <option value="line1">Line-1</option>
                                <option value="line2">Line-2</option>
                                <option value="line3">Line-3</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 두 번째 행: 날짜/시간/조회 버튼 -->
                    <div class="light-filter-row" style="background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div class="row g-2 align-items-center">
                            <!-- 날짜 선택 -->
                            <div class="col-2">
                                <input type="date" class="form-control" id="searchDate" value="2025-07-18" style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #333; border-radius: 8px;">
                            </div>
                            
                            <!-- 시작 시간 -->
                            <div class="col-2">
                                <div class="input-group">
                                    <span class="input-group-text" style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6; border-radius: 8px 0 0 8px;">오전</span>
                                    <input type="time" class="form-control" id="startTime" value="12:00" style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #333; border-radius: 0 8px 8px 0;">
                                </div>
                            </div>
                            
                            <!-- 종료 시간 -->
                            <div class="col-2">
                                <div class="input-group">
                                    <span class="input-group-text" style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); color: #8b5cf6; border-radius: 8px 0 0 8px;">오전</span>
                                    <input type="time" class="form-control" id="endTime" value="12:00" style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #333; border-radius: 0 8px 8px 0;">
                                </div>
                            </div>
                            
                            <!-- 조회 버튼 -->
                            <div class="col-2">
                                <button class="btn btn-primary w-100" id="searchPowerData" style="background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%); border: none; font-weight: 600; border-radius: 8px; color: white; padding: 8px 16px;">
                                    <i class="fas fa-search me-1"></i> 조회
                                </button>
                            </div>
                            
                            <!-- Export buttons -->
                            <div class="col-4">
                                <div class="d-flex justify-content-end gap-2">
                                    <button class="btn btn-secondary btn-sm" id="resetFilter" title="조건 초기화" style="background: rgba(108, 117, 125, 0.8); border: 1px solid rgba(108, 117, 125, 0.3); color: #fff;">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="btn btn-success btn-sm" id="exportPowerData" title="Excel 다운로드" style="background: rgba(16, 185, 129, 0.8); border: none; color: #fff;">
                                        <i class="fas fa-file-excel"></i>
                                    </button>
                                    <button class="btn btn-info btn-sm" id="exportCsvData" title="CSV 다운로드" style="background: rgba(59, 130, 246, 0.8); border: none; color: #fff;">
                                        <i class="fas fa-file-csv"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="modern-card mb-4">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">전력 트렌드 차트</h3>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-secondary-modern" id="chartFullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-secondary-modern dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" id="chartSettings"><i class="fas fa-sliders-h me-2"></i>차트 설정</a></li>
                                    <li><a class="dropdown-item" href="#" id="exportChartImage"><i class="fas fa-image me-2"></i>이미지로 저장</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- Chart Controls -->
                    <div class="card-body-modern py-2 border-bottom" style="background: rgba(139, 92, 246, 0.05);">
                        <div class="d-flex gap-4 align-items-center">
                            <span class="text-muted-modern" style="font-size: 0.875rem;">표시 항목:</span>
                            <div class="form-check form-check-sm">
                                <input class="form-check-input" type="checkbox" id="voltageCheck" value="voltage" checked>
                                <label class="form-check-label" for="voltageCheck">전압</label>
                            </div>
                            <div class="form-check form-check-sm">
                                <input class="form-check-input" type="checkbox" id="currentCheck" value="current">
                                <label class="form-check-label" for="currentCheck">전류</label>
                            </div>
                            <div class="form-check form-check-sm">
                                <input class="form-check-input" type="checkbox" id="powerCheck" value="power">
                                <label class="form-check-label" for="powerCheck">전력량</label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body-modern">
                        <div class="chart-container" style="height: 400px;">
                            <div id="powerTrendChart" style="width: 100%; height: 100%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="modern-card">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">전력 데이터 상세</h3>
                        <div class="d-flex gap-2">
                            <span class="badge bg-info" id="dataCount">총 0건</span>
                        </div>
                    </div>
                    <div class="card-body-modern">
                        <div class="table-container">
                            <table id="powerDataTable" class="table table-modern table-compact" style="width:100%">
                                <thead>
                                    <tr>
                                        <th style="width: 35%;">
                                            <i class="fas fa-clock me-2" style="color: var(--primary-color);"></i>시간
                                        </th>
                                        <th style="width: 20%; text-align: center;">
                                            <i class="fas fa-bolt me-2" style="color: #8b5cf6;"></i>전압 (V)
                                        </th>
                                        <th style="width: 20%; text-align: center;">
                                            <i class="fas fa-plug me-2" style="color: #3b82f6;"></i>전류 (A)
                                        </th>
                                        <th style="width: 25%; text-align: center;">
                                            <i class="fas fa-battery-three-quarters me-2" style="color: #10b981;"></i>전력량 (kWh)
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label-modern mb-0">페이지당 항목:</label>
                                <select class="form-select form-select-sm" id="pageSize" style="width: auto;">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <nav aria-label="Table pagination">
                                <ul class="pagination pagination-sm mb-0" id="tablePagination">
                                    <!-- Pagination will be generated by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    
    <script src="js/theme-manager.js"></script>
    <script src="js/admin-common.js"></script>
    <script src="js/toast-notifications.js"></script>

    <script>
        $(document).ready(function() {
            let powerDataTable;
            let powerTrendChart;
            let selectedPowerTypes = ['voltage'];

            // Set default dates (last 7 days)
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            $('#startDate').val(lastWeek.toISOString().split('T')[0]);
            $('#endDate').val(today.toISOString().split('T')[0]);
            
            // Check if ECharts is loaded
            if (typeof echarts === 'undefined') {
                console.error('ECharts not loaded');
                return;
            } else {
                console.log('ECharts loaded successfully');
            }

            // Initialize DataTable
            powerDataTable = $('#powerDataTable').DataTable({
                processing: true,
                serverSide: false,
                responsive: true,
                language: {
                    processing: "처리중...",
                    search: "검색:",
                    lengthMenu: "_MENU_ 개씩 보기",
                    info: "_START_ - _END_ / _TOTAL_ 건",
                    infoEmpty: "0건",
                    infoFiltered: "(전체 _MAX_ 건 중 검색결과)",
                    paginate: {
                        first: "처음",
                        last: "마지막", 
                        next: "다음",
                        previous: "이전"
                    }
                },
                data: [],
                columns: [
                    { 
                        data: 'timestamp',
                        title: '시간',
                        render: function(data) {
                            if (!data) return '';
                            const date = new Date(data);
                            const formattedTime = date.toLocaleDateString('ko-KR', {
                                month: '2-digit', 
                                day: '2-digit'
                            }) + ' ' + date.toLocaleTimeString('ko-KR', {
                                hour: '2-digit', 
                                minute: '2-digit'
                            });
                            return `<span class="time-value">${formattedTime}</span>`;
                        }
                    },
                    { 
                        data: 'voltage',
                        title: '전압 (V)',
                        className: 'text-center',
                        render: function(data) {
                            if (data === null || data === undefined) return '';
                            return `<span class="data-value voltage">${parseFloat(data).toFixed(1)}</span>`;
                        }
                    },
                    { 
                        data: 'current',
                        title: '전류 (A)',
                        className: 'text-center',
                        render: function(data) {
                            if (data === null || data === undefined) return '';
                            return `<span class="data-value current">${parseFloat(data).toFixed(2)}</span>`;
                        }
                    },
                    { 
                        data: 'power',
                        title: '전력량 (kWh)',
                        className: 'text-center',
                        render: function(data) {
                            if (data === null || data === undefined) return '';
                            return `<span class="data-value power">${parseFloat(data).toFixed(3)}</span>`;
                        }
                    }
                ],
                order: [[0, 'desc']],
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]]
            });
            
            console.log('DataTable initialized');

            // Load initial data immediately
            loadInitialData();
            
            // Initialize chart after short delay
            setTimeout(() => {
                initializePowerChart();
            }, 300);
            
            function loadInitialData() {
                try {
                    console.log('Loading initial data...');
                    const initialData = generateMockPowerData();
                    console.log('Generated data:', initialData.length, 'items');
                    
                    if (initialData.length > 0) {
                        powerDataTable.clear();
                        powerDataTable.rows.add(initialData);
                        powerDataTable.draw();
                        updateDataCount(initialData.length);
                        console.log('Data loaded to table');
                        
                        // Update chart if it exists
                        setTimeout(() => {
                            if (powerTrendChart) {
                                updateChart();
                            }
                        }, 500);
                    }
                } catch (error) {
                    console.error('Error loading initial data:', error);
                }
            }

            // Generate mock power data
            function generateMockPowerData() {
                try {
                    const data = [];
                    const startDate = new Date($('#startDate').val() || lastWeek);
                    const endDate = new Date($('#endDate').val() || today);
                    
                    console.log('Generating data from:', startDate, 'to:', endDate);
                    
                    // Generate data points every hour for simpler data
                    const interval = 60 * 60 * 1000; // 1 hour in milliseconds
                    
                    for (let time = startDate.getTime(); time <= endDate.getTime(); time += interval) {
                        const timestamp = new Date(time);
                        
                        // Generate simple test data
                        const voltage = 220 + Math.random() * 20; // 220-240V
                        const current = 10 + Math.random() * 20;  // 10-30A
                        const power = voltage * current / 1000;   // Power = V*I/1000
                        
                        data.push({
                            timestamp: timestamp.toISOString(),
                            voltage: Math.round(voltage * 10) / 10,
                            current: Math.round(current * 100) / 100,
                            power: Math.round(power * 1000) / 1000
                        });
                    }
                    
                    console.log('Generated', data.length, 'data points');
                    return data.slice(-50); // Limit to last 50 records for testing
                } catch (error) {
                    console.error('Error generating mock data:', error);
                    return [];
                }
            }

            // Initialize power trend chart with ECharts
            function initializePowerChart() {
                try {
                    if (typeof echarts === 'undefined') {
                        console.error('ECharts not available');
                        return;
                    }
                    
                    const chartContainer = document.getElementById('powerTrendChart');
                    if (!chartContainer) {
                        console.error('Chart container element not found');
                        return;
                    }
                    
                    console.log('Initializing ECharts...');
                    
                    // Dispose existing chart if any
                    if (powerTrendChart) {
                        powerTrendChart.dispose();
                    }
                    
                    // Initialize ECharts instance
                    powerTrendChart = echarts.init(chartContainer, 'dark');
                    
                    // Basic chart configuration
                    const option = {
                        title: {
                            text: '전력 트렌드 차트',
                            textStyle: {
                                color: '#fff',
                                fontSize: 16
                            }
                        },
                        tooltip: {
                            trigger: 'axis',
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            borderColor: 'rgb(139, 92, 246)',
                            textStyle: {
                                color: '#fff'
                            }
                        },
                        legend: {
                            data: ['전압 (V)'],
                            textStyle: {
                                color: '#fff'
                            },
                            top: '8%'
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            top: '20%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: [],
                            axisLine: {
                                lineStyle: {
                                    color: 'rgba(255, 255, 255, 0.3)'
                                }
                            },
                            axisLabel: {
                                color: '#fff'
                            }
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: '전압 (V)',
                                position: 'left',
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: 'rgb(139, 92, 246)'
                                    }
                                },
                                axisLabel: {
                                    color: 'rgb(139, 92, 246)',
                                    formatter: '{value} V'
                                },
                                splitLine: {
                                    show: false
                                },
                                nameTextStyle: {
                                    color: 'rgb(139, 92, 246)'
                                }
                            },
                            {
                                type: 'value',
                                name: '전류 (A)',
                                position: 'right',
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: 'rgb(59, 130, 246)'
                                    }
                                },
                                axisLabel: {
                                    color: 'rgb(59, 130, 246)',
                                    formatter: '{value} A'
                                },
                                splitLine: {
                                    show: false
                                },
                                nameTextStyle: {
                                    color: 'rgb(59, 130, 246)'
                                }
                            },
                            {
                                type: 'value',
                                name: '전력량 (kWh)',
                                position: 'right',
                                offset: 80,
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: 'rgb(16, 185, 129)'
                                    }
                                },
                                axisLabel: {
                                    color: 'rgb(16, 185, 129)',
                                    formatter: '{value} kWh'
                                },
                                splitLine: {
                                    show: true,
                                    lineStyle: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                },
                                nameTextStyle: {
                                    color: 'rgb(16, 185, 129)'
                                }
                            }
                        ],
                        series: [{
                            name: '전압 (V)',
                            type: 'line',
                            smooth: true,
                            lineStyle: {
                                color: 'rgb(139, 92, 246)',
                                width: 3
                            },
                            itemStyle: {
                                color: 'rgb(139, 92, 246)'
                            },
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [{
                                        offset: 0, color: 'rgba(139, 92, 246, 0.3)'
                                    }, {
                                        offset: 1, color: 'rgba(139, 92, 246, 0.1)'
                                    }]
                                }
                            },
                            data: []
                        }]
                    };
                    
                    // Set the configuration option to chart
                    powerTrendChart.setOption(option);
                    
                    // Make chart responsive
                    window.addEventListener('resize', () => {
                        if (powerTrendChart) {
                            powerTrendChart.resize();
                        }
                    });
                    
                    console.log('ECharts initialized successfully');
                    
                    // Update chart with current data
                    updateChart();
                    
                } catch (error) {
                    console.error('Error initializing ECharts:', error);
                }
            }

            // Update chart based on selected power types
            function updateChart() {
                try {
                    if (!powerTrendChart) {
                        console.log('Chart not ready yet');
                        return;
                    }
                    
                    const data = powerDataTable.data().toArray();
                    console.log('Updating chart with', data.length, 'data points');
                    
                    if (data.length === 0) {
                        console.log('No data to display in chart');
                        powerTrendChart.setOption({
                            xAxis: {
                                data: []
                            },
                            series: [{
                                name: '전압 (V)',
                                data: []
                            }]
                        });
                        return;
                    }
                    
                    // Sort data by timestamp
                    data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    // Prepare chart data
                    const xAxisData = data.map(item => {
                        const date = new Date(item.timestamp);
                        return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
                    });
                    
                    const powerTypeConfig = {
                        'voltage': {
                            name: '전압 (V)',
                            color: 'rgb(139, 92, 246)',
                            data: data.map(item => parseFloat(item.voltage).toFixed(1)),
                            yAxisIndex: 0
                        },
                        'current': {
                            name: '전류 (A)',
                            color: 'rgb(59, 130, 246)',
                            data: data.map(item => parseFloat(item.current).toFixed(2)),
                            yAxisIndex: 1
                        },
                        'power': {
                            name: '전력량 (kWh)',
                            color: 'rgb(16, 185, 129)',
                            data: data.map(item => parseFloat(item.power).toFixed(3)),
                            yAxisIndex: 2
                        }
                    };
                    
                    // Create series based on selected types
                    const series = selectedPowerTypes.map(type => ({
                        name: powerTypeConfig[type].name,
                        type: 'line',
                        smooth: true,
                        yAxisIndex: powerTypeConfig[type].yAxisIndex,
                        lineStyle: {
                            color: powerTypeConfig[type].color,
                            width: 3
                        },
                        itemStyle: {
                            color: powerTypeConfig[type].color
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: powerTypeConfig[type].color.replace('rgb', 'rgba').replace(')', ', 0.2)')
                                }, {
                                    offset: 1, color: powerTypeConfig[type].color.replace('rgb', 'rgba').replace(')', ', 0.05)')
                                }]
                            }
                        },
                        data: powerTypeConfig[type].data
                    }));
                    
                    console.log('Chart series:', series.length);
                    
                    // Show/hide Y axes based on selected types
                    const yAxisOptions = [
                        { // 전압
                            show: selectedPowerTypes.includes('voltage'),
                            type: 'value',
                            name: selectedPowerTypes.includes('voltage') ? '전압 (V)' : '',
                            position: 'left',
                            axisLine: {
                                show: selectedPowerTypes.includes('voltage'),
                                lineStyle: {
                                    color: 'rgb(139, 92, 246)'
                                }
                            },
                            axisLabel: {
                                show: selectedPowerTypes.includes('voltage'),
                                color: 'rgb(139, 92, 246)',
                                formatter: '{value} V'
                            },
                            splitLine: {
                                show: false
                            },
                            nameTextStyle: {
                                color: 'rgb(139, 92, 246)'
                            }
                        },
                        { // 전류
                            show: selectedPowerTypes.includes('current'),
                            type: 'value',
                            name: selectedPowerTypes.includes('current') ? '전류 (A)' : '',
                            position: 'right',
                            axisLine: {
                                show: selectedPowerTypes.includes('current'),
                                lineStyle: {
                                    color: 'rgb(59, 130, 246)'
                                }
                            },
                            axisLabel: {
                                show: selectedPowerTypes.includes('current'),
                                color: 'rgb(59, 130, 246)',
                                formatter: '{value} A'
                            },
                            splitLine: {
                                show: false
                            },
                            nameTextStyle: {
                                color: 'rgb(59, 130, 246)'
                            }
                        },
                        { // 전력량
                            show: selectedPowerTypes.includes('power'),
                            type: 'value',
                            name: selectedPowerTypes.includes('power') ? '전력량 (kWh)' : '',
                            position: 'right',
                            offset: selectedPowerTypes.includes('current') ? 80 : 0,
                            axisLine: {
                                show: selectedPowerTypes.includes('power'),
                                lineStyle: {
                                    color: 'rgb(16, 185, 129)'
                                }
                            },
                            axisLabel: {
                                show: selectedPowerTypes.includes('power'),
                                color: 'rgb(16, 185, 129)',
                                formatter: '{value} kWh'
                            },
                            splitLine: {
                                show: selectedPowerTypes.includes('power') && selectedPowerTypes.length === 1,
                                lineStyle: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            nameTextStyle: {
                                color: 'rgb(16, 185, 129)'
                            }
                        }
                    ];

                    // Update chart
                    powerTrendChart.setOption({
                        legend: {
                            data: selectedPowerTypes.map(type => powerTypeConfig[type].name)
                        },
                        xAxis: {
                            data: xAxisData
                        },
                        yAxis: yAxisOptions,
                        series: series
                    });
                    
                    console.log('ECharts updated successfully');
                    
                } catch (error) {
                    console.error('Error updating ECharts:', error);
                }
            }

            // Checkbox change event
            $('input[type="checkbox"][id$="Check"]').change(function() {
                const value = $(this).val();
                if ($(this).is(':checked')) {
                    if (!selectedPowerTypes.includes(value)) {
                        selectedPowerTypes.push(value);
                    }
                } else {
                    selectedPowerTypes = selectedPowerTypes.filter(type => type !== value);
                }
                
                // Ensure at least one type is selected
                if (selectedPowerTypes.length === 0) {
                    $(this).prop('checked', true);
                    selectedPowerTypes.push(value);
                    window.ToastNotifications.warning('최소 하나의 항목은 선택되어야 합니다.');
                    return;
                }
                
                updateChart();
            });

            // Search button
            $('#searchPowerData').click(function() {
                const startDate = $('#startDate').val();
                const endDate = $('#endDate').val();
                const floor = $('#floorSelect').val();
                const dcu = $('#dcuSelect').val();
                const busway = $('#buswaySelect').val();
                const line = $('#lineSelect').val();
                
                if (!startDate || !endDate) {
                    window.ToastNotifications.warning('시작 날짜와 종료 날짜를 선택해주세요.');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    window.ToastNotifications.error('시작 날짜는 종료 날짜보다 이전이어야 합니다.');
                    return;
                }

                // Show loading
                const btn = $(this);
                const originalText = btn.html();
                btn.html('<i class="fas fa-spinner fa-spin"></i> 조회 중...');
                btn.prop('disabled', true);

                // Simulate API call
                setTimeout(() => {
                    try {
                        console.log('Generating new data for search...');
                        const newData = generateMockPowerData();
                        console.log('Search generated:', newData.length, 'items');
                        
                        if (newData.length > 0) {
                            // Update table
                            powerDataTable.clear();
                            powerDataTable.rows.add(newData);
                            powerDataTable.draw();
                            console.log('Table updated with new data');
                            
                            // Update chart with same data
                            setTimeout(() => {
                                updateChart();
                            }, 100);
                            
                            updateDataCount(newData.length);
                            window.ToastNotifications.success(`${newData.length}건의 데이터를 조회했습니다.`);
                        } else {
                            window.ToastNotifications.warning('조회된 데이터가 없습니다.');
                        }
                    } catch (error) {
                        console.error('Error during search:', error);
                        window.ToastNotifications.error('데이터 조회 중 오류가 발생했습니다.');
                    }
                    
                    btn.html(originalText);
                    btn.prop('disabled', false);
                }, 1500);
            });

            // Reset filter
            $('#resetFilter').click(function() {
                $('#floorSelect, #dcuSelect, #buswaySelect, #lineSelect').val('');
                $('#startDate').val(lastWeek.toISOString().split('T')[0]);
                $('#endDate').val(today.toISOString().split('T')[0]);
                $('#startTime').val('00:00');
                $('#endTime').val('23:59');
                
                // Reset checkboxes
                $('input[type="checkbox"][id$="Check"]').prop('checked', false);
                $('#voltageCheck').prop('checked', true);
                selectedPowerTypes = ['voltage'];
                
                updateChart();
                window.ToastNotifications.info('필터가 초기화되었습니다.');
            });

            // Export functions
            $('#exportPowerData').click(function() {
                window.ToastNotifications.info('Excel 파일을 생성하는 중입니다...');
                setTimeout(() => {
                    window.ToastNotifications.success('Excel 파일이 다운로드되었습니다.');
                }, 2000);
            });

            $('#exportCsvData').click(function() {
                window.ToastNotifications.info('CSV 파일을 생성하는 중입니다...');
                setTimeout(() => {
                    window.ToastNotifications.success('CSV 파일이 다운로드되었습니다.');
                }, 2000);
            });

            // Chart controls
            $('#chartFullscreen').click(function() {
                const chartContainer = document.getElementById('powerTrendChart');
                if (chartContainer.requestFullscreen) {
                    chartContainer.requestFullscreen();
                }
            });

            $('#exportChartImage').click(function() {
                if (powerTrendChart) {
                    const url = powerTrendChart.getDataURL({
                        type: 'png',
                        backgroundColor: '#1a1a1a'
                    });
                    const link = document.createElement('a');
                    link.download = `power-trend-${new Date().toISOString().split('T')[0]}.png`;
                    link.href = url;
                    link.click();
                    window.ToastNotifications.success('차트 이미지가 저장되었습니다.');
                }
            });

            // Update data count
            function updateDataCount(count) {
                $('#dataCount').text(`총 ${count}건`);
            }

            // Initialize data count
            updateDataCount(powerDataTable.data().length);

            // Page size change
            $('#pageSize').change(function() {
                powerDataTable.page.len(parseInt($(this).val())).draw();
            });

            // Auto refresh every 5 minutes
            setInterval(() => {
                if ($('#autoRefresh').is(':checked')) {
                    $('#searchPowerData').click();
                }
            }, 300000);
        });
    </script>
</body>
</html>
