<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장애 임계치 설정 | 삼송 데이터센터 DCIM</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="lib/bootstrap/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="lib/datatables/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="lib/datatables/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="lib/datatables/buttons.bootstrap5.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="lib/fontawesome/all.min.css">
    <link rel="stylesheet" href="lib/fontawesome/fontawesome-fixed.css">
    
    <!-- ECharts -->
    <script src="lib/echarts/echarts.min.js"></script>
    
    <!-- Custom CSS -->
    <link href="css/pretendard.css" rel="stylesheet">
    <link href="css/themes.css" rel="stylesheet">
    <link href="css/modern-admin.css" rel="stylesheet">
    
    <style>
        /* Custom column widths for compact layout */
        .col-md-1-5 {
            flex: 0 0 auto;
            width: 12%;
        }
        
        @media (max-width: 768px) {
            .col-md-1-5 {
                width: 50%;
            }
        }
        
        /* Compact form controls */
        .form-control-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .form-check-sm .form-check-input {
            margin-top: 0.125em;
        }
        
        .form-check-sm .form-check-label {
            font-size: 0.875rem;
        }
        
        /* Compact card body */
        .card-body-modern.py-3 {
            padding: 1rem 1.5rem;
        }
        
        /* Hide DataTables default buttons and search */
        .dt-buttons {
            display: none;
        }
        
        .hidden-csv-btn, .hidden-excel-btn {
            display: none !important;
        }
        
        .dataTables_filter {
            display: none;
        }
        
        /* Larger font for data count */
        .dataTables_info {
            font-size: 1.1rem !important;
            font-weight: 600 !important;
            color: var(--primary-color) !important;
        }
        
        /* Fault Count Cards Styling */
        .fault-count-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            height: 100px;
        }
        
        .fault-count-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #8b5cf6, #3b82f6);
        }
        
        .fault-count-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
        }
        
        .fault-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .fault-icon.trip-error {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .fault-icon.comm-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .fault-icon.voltage-error {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .fault-icon.current-error {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }
        
        .fault-icon.power-error {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .fault-info {
            flex: 1;
        }
        
        .fault-title {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
            margin: 0 0 8px 0;
        }
        
        .fault-count {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }
        
        /* Table Search Filter Styling */
        .table-search-filter {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .table-search-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: white;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 14px;
        }
        
        .table-search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .table-search-input:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 0.2rem rgba(139, 92, 246, 0.25);
            background: rgba(255, 255, 255, 0.15);
            outline: none;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="logo-text">삼송 데이터센터</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">조회 보고서</div>
                    <div class="nav-item">
                        <a href="powerInquiry.html" class="nav-link">
                            <i class="fas fa-bolt"></i>
                            <span class="nav-text">전력조회</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="faultInquiry.html" class="nav-link">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="nav-text">장애조회</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">설정</div>
                    <div class="nav-item">
                        <a href="alarmSetting.html" class="nav-link active">
                            <i class="fas fa-bell"></i>
                            <span class="nav-text">장애임계치 설정</span>
                        </a>
                    </div>

                </div>

                <div class="nav-section">
                    <div class="nav-section-title">사용자관리</div>
                    <div class="nav-item">
                        <a href="adminsysuser.html" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span class="nav-text">사용자관리</span>
                        </a>
                    </div>
                </div>
            </nav>

            <div class="sidebar-user">
                <div class="user-profile">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name">관리자</div>
                        <div class="user-role">시스템 관리자</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-content">
                    <div class="header-left">
                        <button class="sidebar-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <h1 class="page-title">장애임계치 설정</h1>
                            <nav class="breadcrumb-custom">
                                <a href="#">삼송 데이터센터</a>
                                <i class="fas fa-chevron-right"></i>
                                <span>설정</span>
                                <i class="fas fa-chevron-right"></i>
                                <strong>장애임계치 설정</strong>
                            </nav>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn" id="refreshData" title="데이터 새로고침">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="header-btn" id="exportData" title="데이터 내보내기">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="header-btn has-notification" title="알림">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="header-btn" title="설정">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="header-btn" title="로그아웃">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <div class="content-area" style="padding-right: 16px; margin-right: 0;">
                <!-- Filter Controls -->
                <div class="filter-container mb-4">
                    <!-- 첫 번째 행: 드롭다운 선택 -->
                    <div class="row g-2 mb-3">
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12">
                            <select class="form-select form-select-light" id="floorFilter" style="border-radius: 25px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #666;">
                                <option value="all">전체층</option>
                                <option value="1f">1층</option>
                                <option value="2f">2층</option>
                                <option value="3f">3층</option>
                                <option value="4f">4층</option>
                                <option value="5f">5층</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12">
                            <select class="form-select form-select-light" id="dcuFilter" style="border-radius: 25px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #666;">
                                <option value="all">전체 DCU</option>
                                <option value="dcu1">DCU-001</option>
                                <option value="dcu2">DCU-002</option>
                                <option value="dcu3">DCU-003</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-12 col-12">
                            <button class="btn btn-primary w-100" id="searchAlarmData" style="background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%); border: none; font-weight: 600; border-radius: 8px; color: white; padding: 8px 16px;">
                                <i class="fas fa-search me-1"></i> 조회
                            </button>
                        </div>
                        <div class="col-lg-4 col-md-12 col-sm-12 col-12">
                            <div class="d-flex justify-content-lg-end justify-content-center gap-2 mt-lg-0 mt-2">
                                <button class="btn btn-secondary btn-sm" id="resetFilter" title="조건 초기화" style="background: rgba(108, 117, 125, 0.8); border: 1px solid rgba(108, 117, 125, 0.3); color: #fff;">
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button class="btn btn-success btn-sm" id="exportExcel" title="Excel 다운로드" style="background: rgba(16, 185, 129, 0.8); border: none; color: #fff;">
                                    <i class="fas fa-file-excel"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" id="exportPDF" title="PDF 다운로드" style="background: rgba(239, 68, 68, 0.8); border: none; color: #fff;">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alarm Settings Table -->
                <div class="modern-card">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">임계치 설정</h3>
                        <div class="d-flex gap-2">
                            <span class="badge bg-success" id="dataCount">설정 가능한 항목들</span>
                        </div>
                    </div>
                    

                    
                    <div class="card-body-modern">
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs nav-tabs-modern mb-4" id="alarmTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="current-tab" data-bs-toggle="tab" data-bs-target="#current-pane" type="button" role="tab" aria-controls="current-pane" aria-selected="true">
                                    <i class="fas fa-bolt me-2"></i>전류 임계치 설정
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="voltage-tab" data-bs-toggle="tab" data-bs-target="#voltage-pane" type="button" role="tab" aria-controls="voltage-pane" aria-selected="false">
                                    <i class="fas fa-plug me-2"></i>전압 임계치 설정
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="power-tab" data-bs-toggle="tab" data-bs-target="#power-pane" type="button" role="tab" aria-controls="power-pane" aria-selected="false">
                                    <i class="fas fa-battery-three-quarters me-2"></i>전력량 임계치 설정
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="alarmTabContent">
                            <!-- Current Tab Pane -->
                            <div class="tab-pane fade show active" id="current-pane" role="tabpanel" aria-labelledby="current-tab">
                                <div class="table-container" style="overflow-x: auto; min-width: 0; width: 100%;">
                                    <table id="currentTable" class="table table-modern table-compact" style="width: 100%; min-width: 1200px;">
                                        <thead></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Voltage Tab Pane -->
                            <div class="tab-pane fade" id="voltage-pane" role="tabpanel" aria-labelledby="voltage-tab">
                                <div class="table-container" style="overflow-x: auto; min-width: 0; width: 100%;">
                                    <table id="voltageTable" class="table table-modern table-compact" style="width: 100%; min-width: 1200px;">
                                        <thead></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Power Tab Pane -->
                            <div class="tab-pane fade" id="power-pane" role="tabpanel" aria-labelledby="power-tab">
                                <div class="table-container" style="overflow-x: auto; min-width: 0; width: 100%;">
                                    <table id="powerTable" class="table table-modern table-compact" style="width: 100%; min-width: 1200px;">
                                        <thead></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Threshold Edit Modal -->
    <div class="modal fade" id="thresholdEditModal" tabindex="-1" aria-labelledby="thresholdEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 16px;">
                <div class="modal-header border-0" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title" id="thresholdEditModalLabel" style="color: #333; font-weight: 600;">
                        <span id="modalTabType">전류</span> 임계치 설정
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <!-- Device Info -->
                    <div class="mb-4" style="background: rgba(139, 92, 246, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.2);">
                        <div class="row text-center">
                            <div class="col-3">
                                <strong>층: </strong><span id="modalFloor">1층</span>
                            </div>
                            <div class="col-3">
                                <strong>DCU: </strong><span id="modalDcu">1</span>
                            </div>
                            <div class="col-3">
                                <strong>BUSWAY: </strong><span id="modalBusway">2</span>
                            </div>
                            <div class="col-3">
                                <strong>라인: </strong><span id="modalLine">a</span>
                            </div>
                        </div>
                    </div>

                    <!-- Threshold Settings -->
                    <div class="row g-4">
                        <!-- R Phase -->
                        <div class="col-md-4">
                            <div class="threshold-section" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; background: rgba(255, 255, 255, 0.8);">
                                <h6 class="text-center mb-3" style="font-weight: 600; color: #333;" id="modalRTitle">I_R</h6>
                                <div class="mb-3 text-center">
                                    <label class="form-label" style="font-weight: 500;">Enable</label>
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" id="modalREnabled" style="transform: scale(1.5);">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight: 500;">HH</label>
                                    <input type="number" class="form-control" id="modalRHH" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight: 500;">H</label>
                                    <input type="number" class="form-control" id="modalRH" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight: 500;">L</label>
                                    <input type="number" class="form-control" id="modalRL" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                                <div class="mb-0">
                                    <label class="form-label" style="font-weight: 500;">LL</label>
                                    <input type="number" class="form-control" id="modalRLL" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                            </div>
                        </div>

                        <!-- S Phase -->
                        <div class="col-md-4">
                            <div class="threshold-section" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; background: rgba(255, 255, 255, 0.8);">
                                <h6 class="text-center mb-3" style="font-weight: 600; color: #333;" id="modalSTitle">I_S</h6>
                                <div class="mb-3 text-center">
                                    <label class="form-label" style="font-weight: 500;">Enable</label>
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" id="modalSEnabled" style="transform: scale(1.5);">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight: 500;">HH</label>
                                    <input type="number" class="form-control" id="modalSHH" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight: 500;">H</label>
                                    <input type="number" class="form-control" id="modalSH" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight: 500;">L</label>
                                    <input type="number" class="form-control" id="modalSL" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                                <div class="mb-0">
                                    <label class="form-label" style="font-weight: 500;">LL</label>
                                    <input type="number" class="form-control" id="modalSLL" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                            </div>
                        </div>

                        <!-- T Phase -->
                        <div class="col-md-4">
                            <div class="threshold-section" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; background: rgba(255, 255, 255, 0.8);">
                                <h6 class="text-center mb-3" style="font-weight: 600; color: #333;" id="modalTTitle">I_T</h6>
                                <div class="mb-3 text-center">
                                    <label class="form-label" style="font-weight: 500;">Enable</label>
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" id="modalTEnabled" style="transform: scale(1.5);">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight: 500;">HH</label>
                                    <input type="number" class="form-control" id="modalTHH" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight: 500;">H</label>
                                    <input type="number" class="form-control" id="modalTH" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-weight: 500;">L</label>
                                    <input type="number" class="form-control" id="modalTL" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                                <div class="mb-0">
                                    <label class="form-label" style="font-weight: 500;">LL</label>
                                    <input type="number" class="form-control" id="modalTLL" style="border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0" style="padding: 20px 30px;">
                    <button type="button" class="btn" data-bs-dismiss="modal" style="background: rgba(108, 117, 125, 0.8); border: 1px solid rgba(108, 117, 125, 0.3); color: #fff; border-radius: 8px; padding: 8px 24px; font-weight: 500;">취소</button>
                    <button type="button" class="btn" id="saveThresholdBtn" style="background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%); border: none; color: white; border-radius: 8px; padding: 8px 24px; font-weight: 500;">수정</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="lib/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="lib/jquery/jquery-3.7.1.min.js"></script>
    <script src="lib/datatables/jquery.dataTables.min.js"></script>
    <script src="lib/datatables/dataTables.bootstrap5.min.js"></script>
    <script src="lib/datatables/dataTables.responsive.min.js"></script>
    <script src="lib/datatables/responsive.bootstrap5.min.js"></script>
    <script src="lib/datatables/dataTables.buttons.min.js"></script>
    <script src="lib/datatables/buttons.bootstrap5.min.js"></script>
    <script src="lib/datatables/jszip.min.js"></script>
    <script src="lib/datatables/buttons.html5.min.js"></script>
    <script src="lib/datatables/xlsx.full.min.js"></script>
    <script src="lib/datatables/jspdf.umd.min.js"></script>
    <script src="lib/datatables/jspdf.plugin.autotable.min.js"></script>

    
    <script src="js/admin-common.js"></script>
    <script src="js/toast-notifications.js"></script>
    <script src="lib/axios/axios.min.js"></script>

    <script>
        $(document).ready(function() {
            // Initialize global variables
            var tables = {
                current: null,
                voltage: null,
                power: null
            };
            
            let currentData = [];
            let voltageData = [];
            let powerData = [];

            // Load initial data from API
            async function loadInitialData() {
                try {
                    console.log('Loading initial data from API...');
                    
                    // Load current threshold data
                    const currentResponse = await axios.get('/api/alarm-thresholds');
                    currentData = currentResponse.data;
                    console.log('Current data loaded:', currentData.length, 'items');
                    
                    // Load voltage threshold data
                    const voltageResponse = await axios.get('/api/voltage-thresholds');
                    voltageData = voltageResponse.data;
                    console.log('Voltage data loaded:', voltageData.length, 'items');
                    
                    // Load power threshold data
                    const powerResponse = await axios.get('/api/power-thresholds');
                    powerData = powerResponse.data;
                    console.log('Power data loaded:', powerData.length, 'items');
                    
                    console.log('All initial data loaded successfully');
                    
                } catch (error) {
                    console.error('Error loading initial data:', error);
                    showToast('데이터 로드 중 오류가 발생했습니다', 'error');
                }
            }
            
            // Call loadInitialData and wait for completion
            loadInitialData().then(() => {
                // Bind edit buttons after initial data is loaded
                setTimeout(bindEditButtons, 500);
            });

            // Common table configuration
            const tableConfig = {
                processing: true,
                serverSide: false,
                responsive: true,
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6">><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                language: {
                    processing: "처리중...",
                    search: "검색:",
                    lengthMenu: "_MENU_ 개씩 보기",
                    info: "_START_ - _END_ / _TOTAL_ 건",
                    infoEmpty: "0건",
                    infoFiltered: "(전체 _MAX_ 건 중 검색결과)",
                    paginate: {
                        first: "처음",
                        last: "마지막", 
                        next: "다음",
                        previous: "이전"
                    }
                },
                order: /*<![CDATA[*/ [[1, 'asc']], /*]]>*/
                pageLength: 10,
                lengthMenu: /*<![CDATA[*/ [[10, 25, 50, 100], [10, 25, 50, 100]] /*]]>*/
            };

            // Remove duplicate function - use unified createTableColumns instead

            // Initialize tables with unified single-header structure
            try {
                console.log('Creating unified single-header tables...');
                
                // Single-row header column definition (exactly like the image)
                function createTableColumns(prefix) {
                    const upperPrefix = prefix.toUpperCase();
                    return [
                        { 
                            title: '수정', 
                            data: null, 
                            defaultContent: '<button class="btn btn-sm btn-outline-primary edit-threshold-btn" type="button"><i class="fas fa-edit"></i></button>', 
                            orderable: false,
                            className: 'text-center',
                            width: '5%'
                        },
                        { title: 'BUSWAY', data: 'busway', className: 'text-center', width: '8%' },
                        { title: 'LINE', data: 'line', className: 'text-center', width: '6%' },
                        { 
                            title: upperPrefix + '_R EN', 
                            data: prefix + '_r_en', 
                            className: 'text-center', 
                            width: '6%',
                            render: function(data) {
                                return data === 'checked' ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-times-circle text-danger"></i>';
                            }
                        },
                        { title: upperPrefix + '_R HH', data: prefix + '_r_hh', className: 'text-center', width: '6%' },
                        { title: upperPrefix + '_R H', data: prefix + '_r_h', className: 'text-center', width: '6%' },
                        { title: upperPrefix + '_R L', data: prefix + '_r_l', className: 'text-center', width: '6%' },
                        { title: upperPrefix + '_R LL', data: prefix + '_r_ll', className: 'text-center', width: '6%' },
                        { 
                            title: upperPrefix + '_S EN', 
                            data: prefix + '_s_en', 
                            className: 'text-center', 
                            width: '6%',
                            render: function(data) {
                                return data === 'checked' ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-times-circle text-danger"></i>';
                            }
                        },
                        { title: upperPrefix + '_S HH', data: prefix + '_s_hh', className: 'text-center', width: '6%' },
                        { title: upperPrefix + '_S H', data: prefix + '_s_h', className: 'text-center', width: '6%' },
                        { title: upperPrefix + '_S L', data: prefix + '_s_l', className: 'text-center', width: '6%' },
                        { title: upperPrefix + '_S LL', data: prefix + '_s_ll', className: 'text-center', width: '6%' },
                        { 
                            title: upperPrefix + '_T EN', 
                            data: prefix + '_t_en', 
                            className: 'text-center', 
                            width: '6%',
                            render: function(data) {
                                return data === 'checked' ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-times-circle text-danger"></i>';
                            }
                        },
                        { title: upperPrefix + '_T HH', data: prefix + '_t_hh', className: 'text-center', width: '6%' },
                        { title: upperPrefix + '_T H', data: prefix + '_t_h', className: 'text-center', width: '6%' },
                        { title: upperPrefix + '_T L', data: prefix + '_t_l', className: 'text-center', width: '6%' },
                        { title: upperPrefix + '_T LL', data: prefix + '_t_ll', className: 'text-center', width: '6%' }
                    ];
                }

                // Create columns for each table
                const currentColumns = createTableColumns('i');
                const voltageColumns = createTableColumns('v');
                const powerColumns = createTableColumns('kw');

                // Wait for data to load before initializing tables
                function initializeCurrentTable() {
                    if (currentData.length > 0) {
                        tables.current = $('#currentTable').DataTable({
                            data: currentData,
                            columns: currentColumns,
                            pageLength: 10,
                            scrollX: true,
                            scrollCollapse: true,
                            responsive: true,
                            destroy: true,
                            ordering: true,
                            searching: true,
                            autoWidth: false,
                            language: {
                                lengthMenu: "_MENU_ 개씩 보기",
                                info: "_START_ - _END_ / _TOTAL_ 건",
                                paginate: { next: "다음", previous: "이전" }
                            },
                            drawCallback: function() {
                                // Re-bind event handlers after table redraw
                                bindEditButtons();
                            }
                        });
                        console.log('Current table initialized with', currentData.length, 'items');
                    } else {
                        // Retry after a short delay if data not loaded yet
                        setTimeout(initializeCurrentTable, 100);
                    }
                }
                
                // Start initialization
                initializeCurrentTable();

                // Initialize tables only when tabs are clicked
                let voltageTableInitialized = false;
                let powerTableInitialized = false;

                // Tab click handlers for lazy initialization
                $('#voltage-tab').on('click', function() {
                    if (!voltageTableInitialized) {
                        console.log('Initializing voltage table...');
                        
                        // Destroy if exists
                        if ($.fn.DataTable.isDataTable('#voltageTable')) {
                            $('#voltageTable').DataTable().destroy();
                        }
                        
                        // Clear and recreate
                        $('#voltageTable').empty().html('<thead></thead><tbody></tbody>');
                        
                        setTimeout(() => {
                            tables.voltage = $('#voltageTable').DataTable({
                                data: voltageData,
                                columns: voltageColumns,
                                pageLength: 10,
                                scrollX: true,
                                scrollCollapse: true,
                                responsive: true,
                                destroy: true,
                                ordering: true,
                                searching: true,
                                autoWidth: false,
                                language: {
                                    lengthMenu: "_MENU_ 개씩 보기",
                                    info: "_START_ - _END_ / _TOTAL_ 건",
                                    paginate: { next: "다음", previous: "이전" }
                                },
                                drawCallback: function() {
                                    bindEditButtons();
                                }
                            });
                            voltageTableInitialized = true;
                            console.log('Voltage table initialized successfully');
                        }, 50);
                    }
                });

                $('#power-tab').on('click', function() {
                    if (!powerTableInitialized) {
                        console.log('Initializing power table...');
                        
                        // Destroy if exists
                        if ($.fn.DataTable.isDataTable('#powerTable')) {
                            $('#powerTable').DataTable().destroy();
                        }
                        
                        // Clear and recreate
                        $('#powerTable').empty().html('<thead></thead><tbody></tbody>');
                        
                        setTimeout(() => {
                            tables.power = $('#powerTable').DataTable({
                                data: powerData,
                                columns: powerColumns,
                                pageLength: 10,
                                scrollX: true,
                                scrollCollapse: true,
                                responsive: true,
                                destroy: true,
                                ordering: true,
                                searching: true,
                                autoWidth: false,
                                language: {
                                    lengthMenu: "_MENU_ 개씩 보기",
                                    info: "_START_ - _END_ / _TOTAL_ 건",
                                    paginate: { next: "다음", previous: "이전" }
                                },
                                drawCallback: function() {
                                    bindEditButtons();
                                }
                            });
                            powerTableInitialized = true;
                            console.log('Power table initialized successfully');
                        }, 50);
                    }
                });

            } catch (error) {
                console.error('Error initializing tables:', error);
                console.error('Error details:', error.message);
            }



            console.log('All Alarm Settings Tables loaded successfully');
            console.log('Current data sample:', currentData[0]);
            console.log('Current data:', currentData.length, 'items');
            console.log('Voltage data sample:', voltageData[0]);
            console.log('Voltage data:', voltageData.length, 'items');
            console.log('Power data sample:', powerData[0]);
            console.log('Power data:', powerData.length, 'items');
            $('#dataCount').text(`총 ${currentData.length}건`);
            
            // Remove forced refresh as it's causing alignment issues
            console.log('Tables initialized without forced refresh');

            // Event handlers for filter controls
            $('#searchAlarmData').on('click', function() {
                console.log('Search button clicked');
                showToast('알람 설정 조회 완료', 'success');
            });

            $('#floorFilter, #dcuFilter').on('change', function() {
                console.log('Filter changed:', $(this).val());
                // Apply filters here if needed
            });

            // Action button handlers
            $('#resetFilter').on('click', function() {
                console.log('Reset filter clicked');
                $('#floorFilter').val('all');
                $('#dcuFilter').val('all');
                showToast('필터가 초기화되었습니다', 'info');
            });

            $('#exportExcel').on('click', function() {
                console.log('Export Excel clicked');
                exportToExcel();
            });

            $('#exportPDF').on('click', function() {
                console.log('Export PDF clicked');
                exportToPDF();
            });

            // Modal functionality
            let currentEditData = null;
            let activeTable = null;
            let currentPrefix = '';

            // Function to bind edit button events
            function bindEditButtons() {
                $('.edit-threshold-btn').off('click').on('click', function() {
                    console.log('Edit button clicked - event handler working');
                    handleEditButtonClick($(this));
                });
            }
            
            // Handle edit button clicks for all tables
            function handleEditButtonClick($button) {
                console.log('Edit button clicked');
                const $row = $button.closest('tr');
                const activeTabId = $('.nav-tabs .nav-link.active').attr('id');
                console.log('Active tab:', activeTabId);
                
                // Determine which table and prefix based on active tab
                if (activeTabId === 'current-tab') {
                    activeTable = tables.current;
                    currentPrefix = 'i';
                    $('#modalTabType').text('전류');
                    $('#modalRTitle').text('I_R');
                    $('#modalSTitle').text('I_S');
                    $('#modalTTitle').text('I_T');
                } else if (activeTabId === 'voltage-tab') {
                    activeTable = tables.voltage;
                    currentPrefix = 'v';
                    $('#modalTabType').text('전압');
                    $('#modalRTitle').text('V_R');
                    $('#modalSTitle').text('V_S');
                    $('#modalTTitle').text('V_T');
                } else if (activeTabId === 'power-tab') {
                    activeTable = tables.power;
                    currentPrefix = 'kw';
                    $('#modalTabType').text('전력량');
                    $('#modalRTitle').text('KW_R');
                    $('#modalSTitle').text('KW_S');
                    $('#modalTTitle').text('KW_T');
                }

                // Get row data from the table
                currentEditData = activeTable.row($row).data();
                console.log('Row data:', currentEditData);
                
                // Check if we have valid data and table
                if (!currentEditData) {
                    console.error('No row data found');
                    return;
                }
                
                if (!activeTable) {
                    console.error('No active table found');
                    return;
                }
                
                console.log('Populating modal with prefix:', currentPrefix);
                
                // Populate modal with data
                populateModal(currentEditData, currentPrefix);
                
                // Show modal
                console.log('Showing modal...');
                $('#thresholdEditModal').modal('show');
            }

            function populateModal(data, prefix) {
                console.log('populateModal called with:', { data, prefix });
                
                // Set device info (mock data for now)
                $('#modalFloor').text('1층');
                $('#modalDcu').text('1');
                $('#modalBusway').text(data.busway ? data.busway.replace('BW', '') : '1');
                $('#modalLine').text(data.line ? data.line.replace('L', '') : 'a');
                
                console.log('Device info set');

                // Populate R phase data
                $('#modalREnabled').prop('checked', data[`${prefix}_r_en`] === 'checked');
                $('#modalRHH').val(data[`${prefix}_r_hh`] || '');
                $('#modalRH').val(data[`${prefix}_r_h`] || '');
                $('#modalRL').val(data[`${prefix}_r_l`] || '');
                $('#modalRLL').val(data[`${prefix}_r_ll`] || '');

                // Populate S phase data
                $('#modalSEnabled').prop('checked', data[`${prefix}_s_en`] === 'checked');
                $('#modalSHH').val(data[`${prefix}_s_hh`] || '');
                $('#modalSH').val(data[`${prefix}_s_h`] || '');
                $('#modalSL').val(data[`${prefix}_s_l`] || '');
                $('#modalSLL').val(data[`${prefix}_s_ll`] || '');

                // Populate T phase data
                $('#modalTEnabled').prop('checked', data[`${prefix}_t_en`] === 'checked');
                $('#modalTHH').val(data[`${prefix}_t_hh`] || '');
                $('#modalTH').val(data[`${prefix}_t_h`] || '');
                $('#modalTL').val(data[`${prefix}_t_l`] || '');
                $('#modalTLL').val(data[`${prefix}_t_ll`] || '');
            }

            // Handle save button
            $('#saveThresholdBtn').on('click', function() {
                if (!currentEditData || !activeTable) return;

                // Update data object
                currentEditData[`${currentPrefix}_r_en`] = $('#modalREnabled').prop('checked') ? 'checked' : 'unchecked';
                currentEditData[`${currentPrefix}_r_hh`] = $('#modalRHH').val();
                currentEditData[`${currentPrefix}_r_h`] = $('#modalRH').val();
                currentEditData[`${currentPrefix}_r_l`] = $('#modalRL').val();
                currentEditData[`${currentPrefix}_r_ll`] = $('#modalRLL').val();

                currentEditData[`${currentPrefix}_s_en`] = $('#modalSEnabled').prop('checked') ? 'checked' : 'unchecked';
                currentEditData[`${currentPrefix}_s_hh`] = $('#modalSHH').val();
                currentEditData[`${currentPrefix}_s_h`] = $('#modalSH').val();
                currentEditData[`${currentPrefix}_s_l`] = $('#modalSL').val();
                currentEditData[`${currentPrefix}_s_ll`] = $('#modalSLL').val();

                currentEditData[`${currentPrefix}_t_en`] = $('#modalTEnabled').prop('checked') ? 'checked' : 'unchecked';
                currentEditData[`${currentPrefix}_t_hh`] = $('#modalTHH').val();
                currentEditData[`${currentPrefix}_t_h`] = $('#modalTH').val();
                currentEditData[`${currentPrefix}_t_l`] = $('#modalTL').val();
                currentEditData[`${currentPrefix}_t_ll`] = $('#modalTLL').val();

                // Redraw table to reflect changes
                activeTable.draw();
                
                // Close modal
                $('#thresholdEditModal').modal('hide');
                
                // Show success message
                showToast('임계치 설정이 저장되었습니다', 'success');
                
                // Reset variables
                currentEditData = null;
                activeTable = null;
                currentPrefix = '';
            });

            // Reset modal variables when modal is hidden
            $('#thresholdEditModal').on('hidden.bs.modal', function() {
                currentEditData = null;
                activeTable = null;
                currentPrefix = '';
            });

            // Excel export function for all 3 tabs
            function exportToExcel() {
                try {
                    const workbook = XLSX.utils.book_new();
                    
                    // Export Current data
                    if (tables.current) {
                        const currentData = tables.current.rows().data().toArray();
                        const currentSheet = convertTableDataForExport(currentData, 'current');
                        XLSX.utils.book_append_sheet(workbook, currentSheet, '전류 임계치');
                    }
                    
                    // Export Voltage data
                    if (tables.voltage) {
                        const voltageData = tables.voltage.rows().data().toArray();
                        const voltageSheet = convertTableDataForExport(voltageData, 'voltage');
                        XLSX.utils.book_append_sheet(workbook, voltageSheet, '전압 임계치');
                    } else {
                        // Create voltage sheet if table not initialized
                        const voltageSheet = convertTableDataForExport(voltageData, 'voltage');
                        XLSX.utils.book_append_sheet(workbook, voltageSheet, '전압 임계치');
                    }
                    
                    // Export Power data
                    if (tables.power) {
                        const powerData = tables.power.rows().data().toArray();
                        const powerSheet = convertTableDataForExport(powerData, 'power');
                        XLSX.utils.book_append_sheet(workbook, powerSheet, '전력량 임계치');
                    } else {
                        // Create power sheet if table not initialized
                        const powerSheet = convertTableDataForExport(powerData, 'power');
                        XLSX.utils.book_append_sheet(workbook, powerSheet, '전력량 임계치');
                    }
                    
                    // Generate filename with timestamp
                    const now = new Date();
                    const dateStr = now.toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `알람임계치설정_${dateStr}.xlsx`;
                    
                    // Save file
                    XLSX.writeFile(workbook, filename);
                    showToast('Excel 파일이 다운로드되었습니다', 'success');
                    
                } catch (error) {
                    console.error('Excel export error:', error);
                    showToast('Excel 내보내기 중 오류가 발생했습니다', 'error');
                }
            }

            // PDF export function for all 3 tabs
            function exportToPDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape for better table fit
                    
                    let yPosition = 20;
                    
                    // Title
                    doc.setFontSize(16);
                    doc.text('Alarm Threshold Settings Report', 20, yPosition);
                    yPosition += 15;
                    
                    // Current timestamp
                    doc.setFontSize(10);
                    doc.text(`Export Date: ${new Date().toLocaleDateString()}`, 20, yPosition);
                    yPosition += 15;
                    
                    // Export Current table
                    if (tables.current) {
                        const currentData = tables.current.rows().data().toArray();
                        yPosition = addTableToPDF(doc, currentData, 'Current Threshold Settings', 'current', yPosition);
                    }
                    
                    // Export Voltage table (add new page if needed)
                    if (yPosition > 180) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    if (tables.voltage) {
                        const voltageData = tables.voltage.rows().data().toArray();
                        yPosition = addTableToPDF(doc, voltageData, 'Voltage Threshold Settings', 'voltage', yPosition);
                    } else {
                        yPosition = addTableToPDF(doc, voltageData, 'Voltage Threshold Settings', 'voltage', yPosition);
                    }
                    
                    // Export Power table (add new page if needed)
                    if (yPosition > 180) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    if (tables.power) {
                        const powerData = tables.power.rows().data().toArray();
                        yPosition = addTableToPDF(doc, powerData, 'Power Threshold Settings', 'power', yPosition);
                    } else {
                        yPosition = addTableToPDF(doc, powerData, 'Power Threshold Settings', 'power', yPosition);
                    }
                    
                    // Generate filename with timestamp
                    const now = new Date();
                    const dateStr = now.toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `alarm_threshold_settings_${dateStr}.pdf`;
                    
                    // Save file
                    doc.save(filename);
                    showToast('PDF 파일이 다운로드되었습니다', 'success');
                    
                } catch (error) {
                    console.error('PDF export error:', error);
                    showToast('PDF 내보내기 중 오류가 발생했습니다', 'error');
                }
            }

            // Helper function to convert table data for Excel export
            function convertTableDataForExport(data, type) {
                const headers = getExcelHeaders(type);
                const rows = [];
                
                // Add headers
                rows.push(headers);
                
                // Add data rows
                data.forEach(row => {
                    const exportRow = [];
                    exportRow.push(row.busway || '');
                    exportRow.push(row.line || '');
                    
                    const prefix = type === 'current' ? 'i' : (type === 'voltage' ? 'v' : 'kw');
                    
                    // R phase
                    exportRow.push(row[`${prefix}_r_en`] === 'checked' ? 'Y' : 'N');
                    exportRow.push(row[`${prefix}_r_hh`] || '');
                    exportRow.push(row[`${prefix}_r_h`] || '');
                    exportRow.push(row[`${prefix}_r_l`] || '');
                    exportRow.push(row[`${prefix}_r_ll`] || '');
                    
                    // S phase
                    exportRow.push(row[`${prefix}_s_en`] === 'checked' ? 'Y' : 'N');
                    exportRow.push(row[`${prefix}_s_hh`] || '');
                    exportRow.push(row[`${prefix}_s_h`] || '');
                    exportRow.push(row[`${prefix}_s_l`] || '');
                    exportRow.push(row[`${prefix}_s_ll`] || '');
                    
                    // T phase
                    exportRow.push(row[`${prefix}_t_en`] === 'checked' ? 'Y' : 'N');
                    exportRow.push(row[`${prefix}_t_hh`] || '');
                    exportRow.push(row[`${prefix}_t_h`] || '');
                    exportRow.push(row[`${prefix}_t_l`] || '');
                    exportRow.push(row[`${prefix}_t_ll`] || '');
                    
                    rows.push(exportRow);
                });
                
                return XLSX.utils.aoa_to_sheet(rows);
            }

            // Helper function to get Excel headers
            function getExcelHeaders(type) {
                const prefix = type === 'current' ? 'I' : (type === 'voltage' ? 'V' : 'KW');
                return [
                    'BUSWAY', 'LINE',
                    `${prefix}_R_EN`, `${prefix}_R_HH`, `${prefix}_R_H`, `${prefix}_R_L`, `${prefix}_R_LL`,
                    `${prefix}_S_EN`, `${prefix}_S_HH`, `${prefix}_S_H`, `${prefix}_S_L`, `${prefix}_S_LL`,
                    `${prefix}_T_EN`, `${prefix}_T_HH`, `${prefix}_T_H`, `${prefix}_T_L`, `${prefix}_T_LL`
                ];
            }

            // Helper function to add table to PDF
            function addTableToPDF(doc, data, title, type, yPosition) {
                doc.setFontSize(12);
                doc.text(title, 20, yPosition);
                yPosition += 10;
                
                const headers = getPDFHeaders(type);
                const rows = [];
                
                data.forEach(row => {
                    const pdfRow = [];
                    pdfRow.push(row.busway || '');
                    pdfRow.push(row.line || '');
                    
                    const prefix = type === 'current' ? 'i' : (type === 'voltage' ? 'v' : 'kw');
                    
                    // R phase
                    pdfRow.push(row[`${prefix}_r_en`] === 'checked' ? 'Y' : 'N');
                    pdfRow.push(row[`${prefix}_r_hh`] || '');
                    pdfRow.push(row[`${prefix}_r_h`] || '');
                    pdfRow.push(row[`${prefix}_r_l`] || '');
                    pdfRow.push(row[`${prefix}_r_ll`] || '');
                    
                    // S phase
                    pdfRow.push(row[`${prefix}_s_en`] === 'checked' ? 'Y' : 'N');
                    pdfRow.push(row[`${prefix}_s_hh`] || '');
                    pdfRow.push(row[`${prefix}_s_h`] || '');
                    pdfRow.push(row[`${prefix}_s_l`] || '');
                    pdfRow.push(row[`${prefix}_s_ll`] || '');
                    
                    // T phase
                    pdfRow.push(row[`${prefix}_t_en`] === 'checked' ? 'Y' : 'N');
                    pdfRow.push(row[`${prefix}_t_hh`] || '');
                    pdfRow.push(row[`${prefix}_t_h`] || '');
                    pdfRow.push(row[`${prefix}_t_l`] || '');
                    pdfRow.push(row[`${prefix}_t_ll`] || '');
                    
                    rows.push(pdfRow);
                });
                
                // Use autoTable for better formatting
                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: yPosition,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [139, 92, 246] },
                    margin: { left: 20, right: 20 }
                });
                
                return doc.lastAutoTable.finalY + 15;
            }

            // Helper function to get PDF headers (English only to avoid font issues)
            function getPDFHeaders(type) {
                const prefix = type === 'current' ? 'I' : (type === 'voltage' ? 'V' : 'KW');
                return [
                    'BUSWAY', 'LINE',
                    `${prefix}_R_EN`, `${prefix}_R_HH`, `${prefix}_R_H`, `${prefix}_R_L`, `${prefix}_R_LL`,
                    `${prefix}_S_EN`, `${prefix}_S_HH`, `${prefix}_S_H`, `${prefix}_S_L`, `${prefix}_S_LL`,
                    `${prefix}_T_EN`, `${prefix}_T_HH`, `${prefix}_T_H`, `${prefix}_T_L`, `${prefix}_T_LL`
                ];
            }

        });
    </script>
</body>
</html>
