<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장애조회 | 삼송 데이터센터 DCIM</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="lib/bootstrap/bootstrap.min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="lib/datatables/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="lib/datatables/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="lib/datatables/buttons.bootstrap5.min.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="lib/fontawesome/all.min.css">

    <!-- ECharts -->
    <script src="lib/echarts/echarts.min.js"></script>

    <!-- Custom CSS -->
    <link href="css/themes.css" rel="stylesheet">
    <link href="css/modern-admin.css" rel="stylesheet">

    <style>
        /* Custom column widths for compact layout */
        .col-md-1-5 {
            flex: 0 0 auto;
            width: 12%;
        }

        @media (max-width: 768px) {
            .col-md-1-5 {
                width: 50%;
            }
        }

        /* Compact form controls */
        .form-control-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .form-check-sm .form-check-input {
            margin-top: 0.125em;
        }

        .form-check-sm .form-check-label {
            font-size: 0.875rem;
        }

        /* Compact card body */
        .card-body-modern.py-3 {
            padding: 1rem 1.5rem;
        }

        /* Hide DataTables default buttons and search */
        .dt-buttons {
            display: none;
        }

        .hidden-csv-btn, .hidden-excel-btn {
            display: none !important;
        }

        .dataTables_filter {
            display: none;
        }

        /* Larger font for data count */
        .dataTables_info {
            font-size: 1.1rem !important;
            font-weight: 600 !important;
            color: var(--primary-color) !important;
        }

        /* Fault Count Cards Styling */
        .fault-count-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            height: 100px;
        }

        .fault-count-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #8b5cf6, #3b82f6);
        }

        .fault-count-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .fault-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }

        .fault-icon.trip-error {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .fault-icon.comm-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .fault-icon.voltage-error {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .fault-icon.current-error {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
        }

        .fault-icon.power-error {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .fault-info {
            flex: 1;
        }

        .fault-title {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
            margin: 0 0 8px 0;
        }

        .fault-count {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        /* Table Search Filter Styling */
        .table-search-filter {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .table-search-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: white;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 14px;
        }

        .table-search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .table-search-input:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 0.2rem rgba(139, 92, 246, 0.25);
            background: rgba(255, 255, 255, 0.15);
            outline: none;
        }

        /* Fault Level Badge Uniform Width */
        .fault-level-badge {
            min-width: 60px !important;
            max-width: 60px !important;
            width: 60px !important;
            display: inline-block !important;
            text-align: center !important;
            padding: 6px 8px !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            border-radius: 20px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="logo-text">삼송 데이터센터</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">조회 보고서</div>
                    <div class="nav-item">
                        <a href="powerInquiry.html" class="nav-link">
                            <i class="fas fa-bolt"></i>
                            <span class="nav-text">전력조회</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="faultInquiry.html" class="nav-link active">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="nav-text">장애조회</span>
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">설정</div>
                    <div class="nav-item">
                        <a href="alarmSetting.html" class="nav-link">
                            <i class="fas fa-bell"></i>
                            <span class="nav-text">장애임계치 설정</span>
                        </a>
                    </div>

                </div>

                <div class="nav-section">
                    <div class="nav-section-title">사용자관리</div>
                    <div class="nav-item">
                        <a href="adminsysuser.html" class="nav-link">
                            <i class="fas fa-users"></i>
                            <span class="nav-text">사용자관리</span>
                        </a>
                    </div>
                </div>
            </nav>

            <div class="sidebar-user">
                <div class="user-profile">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name">관리자</div>
                        <div class="user-role">시스템 관리자</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <div class="header-content">
                    <div class="header-left">
                        <button class="sidebar-toggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <h1 class="page-title">장애조회</h1>
                            <nav class="breadcrumb-custom">
                                <a href="#">삼송 데이터센터</a>
                                <i class="fas fa-chevron-right"></i>
                                <span>조회 보고서</span>
                                <i class="fas fa-chevron-right"></i>
                                <strong>장애조회</strong>
                            </nav>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn" id="refreshData" title="데이터 새로고침">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="header-btn" id="exportData" title="데이터 내보내기">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="header-btn has-notification" title="알림">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="header-btn" title="설정">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="header-btn" title="로그아웃">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- Filter Controls -->
                <div class="filter-container mb-4">
                    <!-- 첫 번째 행: 드롭다운 선택 -->
                    <div class="row g-2 mb-3">
                        <div class="col-3">
                            <select class="form-select form-select-light" id="totalFilter" style="border-radius: 25px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #666;">
                                <option value="all">전체 중</option>
                                <option value="zone1">Zone 1</option>
                                <option value="zone2">Zone 2</option>
                                <option value="zone3">Zone 3</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <select class="form-select form-select-light" id="dcuFilter" style="border-radius: 25px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #666;">
                                <option value="all">전체 DCU</option>
                                <option value="dcu1">DCU-001</option>
                                <option value="dcu2">DCU-002</option>
                                <option value="dcu3">DCU-003</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <select class="form-select form-select-light" id="faultTypeFilter" style="border-radius: 25px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #666;">
                                <option value="all">장애타입</option>
                                <option value="trip">TRIP 에러</option>
                                <option value="comm">통신 에러</option>
                                <option value="i_r">전압 장애</option>
                                <option value="di1">전류 장애</option>
                                <option value="power">전력량 장애</option>
                                <option value="breaker">차단기 에러</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <select class="form-select form-select-light" id="faultLevelFilter" style="border-radius: 25px; background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #666;">
                                <option value="all">전체등급</option>
                                <option value="H">High (H)</option>
                                <option value="HH">Very High (HH)</option>
                                <option value="L">Low (L)</option>
                                <option value="normal">정상</option>
                            </select>
                        </div>
                    </div>

                    <!-- 두 번째 행: 기간설정/날짜/조회 버튼 -->
                    <div class="light-filter-row" style="background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div class="row g-2 align-items-center">
                            <!-- 기간설정 드롭다운 -->
                            <div class="col-2">
                                <select class="form-select" id="periodSelect" style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #333; border-radius: 8px;">
                                    <option value="1hour" selected>1시간전</option>
                                    <option value="1day">1일전</option>
                                    <option value="7days">7일전</option>
                                    <option value="1month">1개월전</option>
                                    <option value="custom">사용자정의</option>
                                </select>
                            </div>

                            <!-- 시작 날짜 -->
                            <div class="col-2">
                                <input type="date" class="form-control" id="startDate" value="2025-07-18" style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #333; border-radius: 8px;">
                            </div>

                            <!-- 종료 날짜 -->
                            <div class="col-2">
                                <input type="date" class="form-control" id="endDate" value="2025-07-18" style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(139, 92, 246, 0.3); color: #333; border-radius: 8px;">
                            </div>

                            <!-- 조회 버튼 -->
                            <div class="col-2">
                                <button class="btn btn-primary w-100" id="searchFaultData" style="background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%); border: none; font-weight: 600; border-radius: 8px; color: white; padding: 8px 16px;">
                                    <i class="fas fa-search me-1"></i> 조회
                                </button>
                            </div>

                            <!-- Export buttons -->
                            <div class="col-4">
                                <div class="d-flex justify-content-end gap-2">
                                    <button class="btn btn-secondary btn-sm" id="resetFilter" title="조건 초기화" style="background: rgba(108, 117, 125, 0.8); border: 1px solid rgba(108, 117, 125, 0.3); color: #fff;">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="btn btn-success btn-sm" id="exportFaultData" title="Excel 다운로드" style="background: rgba(16, 185, 129, 0.8); border: none; color: #fff;">
                                        <i class="fas fa-file-excel"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" id="exportPdfData" title="PDF 보고서 다운로드" style="background: rgba(239, 68, 68, 0.8); border: none; color: #fff;">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fault Count Cards Section -->
                <div class="modern-card mb-4">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">장애 카운트 현황</h3>
                    </div>
                    <div class="card-body-modern">
                        <div class="row g-3" id="faultCountCards">
                            <div class="col-md-4">
                                <div class="modern-fault-card breaker-card">
                                    <div class="fault-card-content">
                                        <div class="fault-icon-modern">
                                            <i class="fas fa-power-off"></i>
                                        </div>
                                        <div class="fault-details">
                                            <h6 class="fault-label">차단기에러</h6>
                                            <div class="fault-number" id="breakerErrorCount">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-fault-card trip-card">
                                    <div class="fault-card-content">
                                        <div class="fault-icon-modern">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                        <div class="fault-details">
                                            <h6 class="fault-label">TRIP 에러</h6>
                                            <div class="fault-number" id="tripErrorCount">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-fault-card comm-card">
                                    <div class="fault-card-content">
                                        <div class="fault-icon-modern">
                                            <i class="fas fa-wifi"></i>
                                        </div>
                                        <div class="fault-details">
                                            <h6 class="fault-label">통신 에러</h6>
                                            <div class="fault-number" id="commErrorCount">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-fault-card voltage-card">
                                    <div class="fault-card-content">
                                        <div class="fault-icon-modern">
                                            <i class="fas fa-bolt"></i>
                                        </div>
                                        <div class="fault-details">
                                            <h6 class="fault-label">전압 장애</h6>
                                            <div class="fault-number" id="voltageErrorCount">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-fault-card current-card">
                                    <div class="fault-card-content">
                                        <div class="fault-icon-modern">
                                            <i class="fas fa-plug"></i>
                                        </div>
                                        <div class="fault-details">
                                            <h6 class="fault-label">전류 장애</h6>
                                            <div class="fault-number" id="currentErrorCount">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-fault-card power-card">
                                    <div class="fault-card-content">
                                        <div class="fault-icon-modern">
                                            <i class="fas fa-battery-empty"></i>
                                        </div>
                                        <div class="fault-details">
                                            <h6 class="fault-label">전력량 장애</h6>
                                            <div class="fault-number" id="powerErrorCount">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="modern-card">
                    <div class="card-header-modern">
                        <h3 class="card-title-modern">장애 데이터 상세</h3>
                        <div class="d-flex gap-2">
                            <span class="badge bg-info" id="dataCount">총 0건</span>
                        </div>
                    </div>



                    <div class="card-body-modern">

                        <div class="table-container">
                            <table id="faultDataTable" class="table table-modern table-compact" style="width:100%">
                                <thead>
                                    <!-- Column Search Filters -->
                                    <tr class="column-filters">
                                        <th style="width: 15%;">
                                            <!-- 시간 검색 박스 제거 -->
                                        </th>
                                        <th style="width: 10%;">
                                            <input type="text" class="form-control form-control-sm column-search" data-column="1" placeholder="DCU 검색" style="font-size: 12px;">
                                        </th>
                                        <th style="width: 10%;">
                                            <input type="text" class="form-control form-control-sm column-search" data-column="2" placeholder="Busway 검색" style="font-size: 12px;">
                                        </th>
                                        <th style="width: 10%;">
                                            <input type="text" class="form-control form-control-sm column-search" data-column="3" placeholder="Line 검색" style="font-size: 12px;">
                                        </th>
                                        <th style="width: 10%;">
                                            <input type="text" class="form-control form-control-sm column-search" data-column="4" placeholder="Type 검색" style="font-size: 12px;">
                                        </th>
                                        <th style="width: 10%;">
                                            <input type="text" class="form-control form-control-sm column-search" data-column="5" placeholder="등급 검색" style="font-size: 12px;">
                                        </th>
                                        <th style="width: 35%;">
                                            <input type="text" class="form-control form-control-sm column-search" data-column="6" placeholder="알람메시지 검색" style="font-size: 12px;">
                                        </th>
                                    </tr>
                                    <!-- Column Headers -->
                                    <tr>
                                        <th style="width: 15%;">
                                            <i class="fas fa-clock me-2" style="color: var(--primary-color);"></i>시간
                                        </th>
                                        <th style="width: 10%; text-align: center;">
                                            <i class="fas fa-server me-2" style="color: #8b5cf6;"></i>DCU
                                        </th>
                                        <th style="width: 10%; text-align: center;">
                                            <i class="fas fa-plug me-2" style="color: #3b82f6;"></i>Busway
                                        </th>
                                        <th style="width: 10%; text-align: center;">
                                            <i class="fas fa-minus me-2" style="color: #10b981;"></i>Line
                                        </th>
                                        <th style="width: 10%; text-align: center;">
                                            <i class="fas fa-tag me-2" style="color: #f59e0b;"></i>Type
                                        </th>
                                        <th style="width: 10%; text-align: center;">
                                            <i class="fas fa-layer-group me-2" style="color: #ef4444;"></i>등급
                                        </th>
                                        <th style="width: 35%;">
                                            <i class="fas fa-info-circle me-2" style="color: #6b7280;"></i>알람메시지(예시)
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination will be handled by DataTables -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="lib/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="lib/jquery/jquery-3.7.1.min.js"></script>
    <script src="lib/datatables/jquery.dataTables.min.js"></script>
    <script src="lib/datatables/dataTables.bootstrap5.min.js"></script>
    <script src="lib/datatables/dataTables.responsive.min.js"></script>
    <script src="lib/datatables/responsive.bootstrap5.min.js"></script>
    <script src="lib/datatables/dataTables.buttons.min.js"></script>
    <script src="lib/datatables/buttons.bootstrap5.min.js"></script>
    <script src="lib/datatables/jszip.min.js"></script>
    <script src="lib/datatables/buttons.html5.min.js"></script>
    <script src="lib/datatables/xlsx.full.min.js"></script>
    <script src="lib/datatables/jspdf.umd.min.js"></script>
    <script src="lib/datatables/jspdf.plugin.autotable.min.js"></script>


    <script src="js/admin-common.js"></script>
    <script src="js/toast-notifications.js"></script>
    <script src="lib/axios/axios.min.js"></script>

    <script>
        $(document).ready(function() {
            let faultDataTable;
            let faultTrendChart;
            let selectedFaultTypes = ['H'];

            // Set default dates (last 7 days)
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            $('#startDate').val(lastWeek.toISOString().split('T')[0]);
            $('#endDate').val(today.toISOString().split('T')[0]);

            // Check if ECharts is loaded
            if (typeof echarts === 'undefined') {
                console.error('ECharts not loaded');
                return;
            } else {
                console.log('ECharts loaded successfully');
            }

            // Initialize DataTable
            faultDataTable = $('#faultDataTable').DataTable({
                processing: true,
                serverSide: false,
                responsive: true,
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6">><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                buttons: [
                    {
                        extend: 'csv',
                        className: 'hidden-csv-btn',
                        filename: function() {
                            const now = new Date();
                            const dateStr = now.toISOString().slice(0, 19).replace(/:/g, '-');
                            return `전력조회_${dateStr}`;
                        },
                        exportOptions: {
                            columns: [0, 1, 2, 3],
                            format: {
                                body: function(data, row, column, node) {
                                    const tempDiv = document.createElement('div');
                                    tempDiv.innerHTML = data;
                                    return tempDiv.textContent || tempDiv.innerText || '';
                                }
                            }
                        }
                    },
                    {
                        extend: 'excel',
                        className: 'hidden-excel-btn',
                        filename: function() {
                            const now = new Date();
                            const dateStr = now.toISOString().slice(0, 19).replace(/:/g, '-');
                            return `장애조회_${dateStr}`;
                        },
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6],
                            format: {
                                body: function(data, row, column, node) {
                                    const tempDiv = document.createElement('div');
                                    tempDiv.innerHTML = data;
                                    return tempDiv.textContent || tempDiv.innerText || '';
                                }
                            }
                        }
                    }
                ],
                language: {
                    processing: "처리중...",
                    search: "검색:",
                    lengthMenu: "_MENU_ 개씩 보기",
                    info: "_START_ - _END_ / _TOTAL_ 건",
                    infoEmpty: "0건",                    infoFiltered: "(전체 _MAX_ 건 중 검색결과)",
                    paginate: {
                        first: "처음",
                        last: "마지막", 
                        next: "다음",
                        previous: "이전"
                    },
                    buttons: {
                        csv: 'CSV 다운로드'
                    }
                },
                data: [],
                columns: [
                    { 
                        data: 'timestamp',
                        title: '시간',
                        render: function(data) {
                            if (!data) return '';
                            return `<span class="time-value">${data}</span>`;
                        }
                    },
                    { 
                        data: 'dcu',
                        title: 'DCU',
                        className: 'text-center',
                        render: function(data) {
                            if (data === null || data === undefined) return '';
                            return `<span class="data-value dcu">${data}</span>`;
                        }
                    },
                    { 
                        data: 'busway',
                        title: 'Busway',
                        className: 'text-center',
                        render: function(data) {
                            if (data === null || data === undefined) return '';
                            return `<span class="data-value busway">${data}</span>`;
                        }
                    },
                    { 
                        data: 'line',
                        title: 'Line',
                        className: 'text-center',
                        render: function(data) {
                            if (data === null || data === undefined) return '';
                            return `<span class="data-value line">${data}</span>`;
                        }
                    },
                    { 
                        data: 'type',
                        title: 'Type',
                        className: 'text-center',
                        render: function(data) {
                            if (data === null || data === undefined) return '';
                            return `<span class="data-value type">${data}</span>`;
                        }
                    },
                    { 
                        data: 'level',
                        title: '등급',
                        className: 'text-center',
                        render: function(data) {
                            if (data === null || data === undefined) return '';
                            let badgeClass = 'bg-secondary';
                            if (data === 'HH') badgeClass = 'bg-danger';
                            else if (data === 'H') badgeClass = 'bg-warning';
                            else if (data === '정상') badgeClass = 'bg-success';
                            else if (data === '비정상') badgeClass = 'bg-danger';
                            return `<span class="badge ${badgeClass} fault-level-badge">${data}</span>`;
                        }
                    },
                    { 
                        data: 'message',
                        title: '알람메시지(예시)',
                        render: function(data) {
                            if (data === null || data === undefined) return '';
                            return `<span class="message-value">${data}</span>`;
                        }
                    }
                ],
                order: /*<![CDATA[*/ [[0, 'desc']], /*]]>*/
                pageLength: 10,
                lengthMenu: /*<![CDATA[*/ [[10, 25, 50, 100], [10, 25, 50, 100]] /*]]>*/
            });

            console.log('DataTable initialized');

            // Load initial data immediately
            loadInitialData();

            // Initialize chart after short delay
            setTimeout(() => {
                initializeFaultChart();
            }, 300);

            async function loadInitialData() {
                try {
                    console.log('Loading fault data from API...');
                    const response = await axios.get('/api/fault-data');
                    const initialData = response.data;
                    console.log('Loaded data:', initialData.length, 'items');

                    if (initialData.length > 0) {
                        faultDataTable.clear();
                        faultDataTable.rows.add(initialData);
                        faultDataTable.draw();
                        updateDataCount(initialData.length);
                        console.log('Data loaded to table');

                        // Update chart if it exists
                        setTimeout(() => {
                            if (faultTrendChart) {
                                updateChart();
                            }
                        }, 500);
                    }
                } catch (error) {
                    console.error('Error loading fault data:', error);
                    alert('장애 데이터를 불러오는데 실패했습니다.');
                }
            }

            // Generate mock fault data based on attached image structure
            function generateMockFaultData() {
                try {
                    const data = [];
                    const faultTypes = ['i_r', 'di1'];
                    const levels = ['HH', 'H', '정상', '비정상'];
                    const messages = [
                        '임계값 HH : i_r, 현재값 95, 설정값 90',
                        '임계값 H : i_r, 현재값 85, 설정값 80',
                        '임계값 정상 : i_r, 현재값 95',
                        '차단기 비정상',
                        '차단기 정상'
                    ];

                    // Generate sample data based on the image
                    const sampleData = [
                        { timestamp: '1751517297', dcu: 1, busway: 1, line: 'a', type: 'i_r', level: 'HH', message: '임계값 HH : i_r, 현재값 95, 설정값 90' },
                        { timestamp: '1751517297', dcu: 1, busway: 1, line: 'a', type: 'i_r', level: 'H', message: '임계값 H : i_r, 현재값 85, 설정값 80' },
                        { timestamp: '1751517297', dcu: 1, busway: 1, line: 'a', type: 'i_r', level: '정상', message: '임계값 정상 : i_r, 현재값 95' },
                        { timestamp: '1751517297', dcu: 3, busway: 3, line: 'a', type: 'di1', level: '비정상', message: '차단기 비정상' },
                        { timestamp: '1751517297', dcu: 3, busway: 3, line: 'a', type: 'di1', level: '정상', message: '차단기 정상' }
                    ];

                    // Convert timestamps to readable format and add more records
                    for (let i = 0; i < 20; i++) {
                        const baseRecord = sampleData[i % sampleData.length];
                        const date = new Date();
                        date.setHours(date.getHours() - i);

                        data.push({
                            timestamp: date.toLocaleDateString('ko-KR', {
                                month: '2-digit', 
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }),
                            dcu: baseRecord.dcu,
                            busway: baseRecord.busway,
                            line: baseRecord.line,
                            type: baseRecord.type,
                            level: baseRecord.level,
                            message: baseRecord.message
                        });
                    }

                    console.log('Generated', data.length, 'fault data points');
                    return data;
                } catch (error) {
                    console.error('Error generating mock fault data:', error);
                    return [];
                }
            }

            // Initialize fault trend chart with ECharts
            function initializeFaultChart() {
                try {
                    if (typeof echarts === 'undefined') {
                        console.error('ECharts not available');
                        return;
                    }

                    const chartContainer = document.getElementById('faultTrendChart');
                    if (!chartContainer) {
                        console.log('Chart container element not found - chart was replaced with fault count cards');
                        return;
                    }

                    console.log('Initializing ECharts...');

                    // Dispose existing chart if any
                    if (faultTrendChart) {
                        faultTrendChart.dispose();
                    }

                    // Initialize ECharts instance
                    faultTrendChart = echarts.init(chartContainer, 'dark');

                    // Basic chart configuration
                    const option = {
                        title: {
                            text: '장애 트렌드 차트',
                            textStyle: {
                                color: '#fff',
                                fontSize: 16
                            }
                        },
                        tooltip: {
                            trigger: 'axis',
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            borderColor: 'rgb(139, 92, 246)',
                            textStyle: {
                                color: '#fff'
                            }
                        },
                        legend: {
                            data: ['HH', 'H', '정상', '비정상'],
                            textStyle: {
                                color: '#fff'
                            },
                            top: '8%'
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            top: '20%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: [],
                            axisLine: {
                                lineStyle: {
                                    color: 'rgba(255, 255, 255, 0.3)'
                                }
                            },
                            axisLabel: {
                                color: '#fff'
                            }
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: '전압 (V)',
                                position: 'left',
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: 'rgb(139, 92, 246)'
                                    }
                                },
                                axisLabel: {
                                    color: 'rgb(139, 92, 246)',
                                    formatter: '{value} V'
                                },
                                splitLine: {
                                    show: false
                                },
                                nameTextStyle: {
                                    color: 'rgb(139, 92, 246)'
                                }
                            },
                            {
                                type: 'value',
                                name: '전류 (A)',
                                position: 'right',
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: 'rgb(59, 130, 246)'
                                    }
                                },
                                axisLabel: {
                                    color: 'rgb(59, 130, 246)',
                                    formatter: '{value} A'
                                },
                                splitLine: {
                                    show: false
                                },
                                nameTextStyle: {
                                    color: 'rgb(59, 130, 246)'
                                }
                            },
                            {
                                type: 'value',
                                name: '전력량 (kWh)',
                                position: 'right',
                                offset: 80,
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: 'rgb(16, 185, 129)'
                                    }
                                },
                                axisLabel: {
                                    color: 'rgb(16, 185, 129)',
                                    formatter: '{value} kWh'
                                },
                                splitLine: {
                                    show: true,
                                    lineStyle: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                },
                                nameTextStyle: {
                                    color: 'rgb(16, 185, 129)'
                                }
                            }
                        ],
                        series: [{
                            name: '전압 (V)',
                            type: 'line',
                            smooth: true,
                            lineStyle: {
                                color: 'rgb(139, 92, 246)',
                                width: 3
                            },
                            itemStyle: {
                                color: 'rgb(139, 92, 246)'
                            },
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [{
                                        offset: 0, color: 'rgba(139, 92, 246, 0.3)'
                                    }, {
                                        offset: 1, color: 'rgba(139, 92, 246, 0.1)'
                                    }]
                                }
                            },
                            data: []
                        }]
                    };

                    // Set the configuration option to chart
                    faultTrendChart.setOption(option);

                    // Make chart responsive
                    window.addEventListener('resize', () => {
                        if (faultTrendChart) {
                            faultTrendChart.resize();
                        }
                    });

                    console.log('ECharts initialized successfully');

                    // Update chart with current data
                    updateChart();

                } catch (error) {
                    console.error('Error initializing ECharts:', error);
                }
            }

            // Update chart based on selected fault types
            function updateChart() {
                try {
                    if (!faultTrendChart) {
                        console.log('Chart not ready yet');
                        return;
                    }

                    const data = faultDataTable.data().toArray();
                    console.log('Updating chart with', data.length, 'data points');

                    if (data.length === 0) {
                        console.log('No data to display in chart');
                        faultTrendChart.setOption({
                            xAxis: {
                                data: []
                            },
                            series: [{
                                name: 'HH',
                                data: []
                            }]
                        });
                        return;
                    }

                    // Sort data by timestamp
                    data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    // Prepare chart data
                    const xAxisData = data.map(item => {
                        const date = new Date(item.timestamp);
                        return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
                    });

                    const powerTypeConfig = {
                        'voltage': {
                            name: '전압 (V)',
                            color: 'rgb(139, 92, 246)',
                            data: data.map(item => parseFloat(item.voltage).toFixed(1)),
                            yAxisIndex: 0
                        },
                        'current': {
                            name: '전류 (A)',
                            color: 'rgb(59, 130, 246)',
                            data: data.map(item => parseFloat(item.current).toFixed(2)),
                            yAxisIndex: 1
                        },
                        'power': {
                            name: '전력량 (kWh)',
                            color: 'rgb(16, 185, 129)',
                            data: data.map(item => parseFloat(item.power).toFixed(3)),
                            yAxisIndex: 2
                        }
                    };

                    // Create series based on selected types
                    const series = selectedPowerTypes.map(type => ({
                        name: powerTypeConfig[type].name,
                        type: 'line',
                        smooth: true,
                        yAxisIndex: powerTypeConfig[type].yAxisIndex,
                        lineStyle: {
                            color: powerTypeConfig[type].color,
                            width: 3
                        },
                        itemStyle: {
                            color: powerTypeConfig[type].color
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: powerTypeConfig[type].color.replace('rgb', 'rgba').replace(')', ', 0.2)')
                                }, {
                                    offset: 1, color: powerTypeConfig[type].color.replace('rgb', 'rgba').replace(')', ', 0.05)')
                                }]
                            }
                        },
                        data: powerTypeConfig[type].data
                    }));

                    console.log('Chart series:', series.length);

                    // Show/hide Y axes based on selected types
                    const yAxisOptions = [
                        { // 전압
                            show: selectedPowerTypes.includes('voltage'),
                            type: 'value',
                            name: selectedPowerTypes.includes('voltage') ? '전압 (V)' : '',
                            position: 'left',
                            axisLine: {
                                show: selectedPowerTypes.includes('voltage'),
                                lineStyle: {
                                    color: 'rgb(139, 92, 246)'
                                }
                            },
                            axisLabel: {
                                show: selectedPowerTypes.includes('voltage'),
                                color: 'rgb(139, 92, 246)',
                                formatter: '{value} V'
                            },
                            splitLine: {
                                show: false
                            },
                            nameTextStyle: {
                                color: 'rgb(139, 92, 246)'
                            }
                        },
                        { // 전류
                            show: selectedPowerTypes.includes('current'),
                            type: 'value',
                            name: selectedPowerTypes.includes('current') ? '전류 (A)' : '',
                            position: 'right',
                            axisLine: {
                                show: selectedPowerTypes.includes('current'),
                                lineStyle: {
                                    color: 'rgb(59, 130, 246)'
                                }
                            },
                            axisLabel: {
                                show: selectedPowerTypes.includes('current'),
                                color: 'rgb(59, 130, 246)',
                                formatter: '{value} A'
                            },
                            splitLine: {
                                show: false
                            },
                            nameTextStyle: {
                                color: 'rgb(59, 130, 246)'
                            }
                        },
                        { // 전력량
                            show: selectedPowerTypes.includes('power'),
                            type: 'value',
                            name: selectedPowerTypes.includes('power') ? '전력량 (kWh)' : '',
                            position: 'right',
                            offset: selectedPowerTypes.includes('current') ? 80 : 0,
                            axisLine: {
                                show: selectedPowerTypes.includes('power'),
                                lineStyle: {
                                    color: 'rgb(16, 185, 129)'
                                }
                            },
                            axisLabel: {
                                show: selectedPowerTypes.includes('power'),
                                color: 'rgb(16, 185, 129)',
                                formatter: '{value} kWh'
                            },
                            splitLine: {
                                show: selectedPowerTypes.includes('power') && selectedPowerTypes.length === 1,
                                lineStyle: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            nameTextStyle: {
                                color: 'rgb(16, 185, 129)'
                            }
                        }
                    ];

                    // Update chart
                    faultTrendChart.setOption({
                        legend: {
                            data: selectedPowerTypes.map(type => powerTypeConfig[type].name)
                        },
                        xAxis: {
                            data: xAxisData
                        },
                        yAxis: yAxisOptions,
                        series: series
                    });

                    console.log('ECharts updated successfully');

                } catch (error) {
                    console.error('Error updating ECharts:', error);
                }
            }

            // Checkbox change event
            $('input[type="checkbox"][id$="Check"]').change(function() {
                const value = $(this).val();
                if ($(this).is(':checked')) {
                    if (!selectedPowerTypes.includes(value)) {
                        selectedPowerTypes.push(value);
                    }
                } else {
                    selectedPowerTypes = selectedPowerTypes.filter(type => type !== value);
                }

                // Ensure at least one type is selected
                if (selectedPowerTypes.length === 0) {
                    $(this).prop('checked', true);
                    selectedPowerTypes.push(value);
                    window.ToastNotifications.warning('최소 하나의 항목은 선택되어야 합니다.');
                    return;
                }

                updateChart();
            });

            // Search button
            $('#searchFaultData').click(function() {
                const startDate = $('#startDate').val();
                const endDate = $('#endDate').val();
                const floor = $('#floorSelect').val();
                const dcu = $('#dcuSelect').val();
                const busway = $('#buswaySelect').val();
                const line = $('#lineSelect').val();

                if (!startDate || !endDate) {
                    window.ToastNotifications.warning('시작 날짜와 종료 날짜를 선택해주세요.');
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    window.ToastNotifications.error('시작 날짜는 종료 날짜보다 이전이어야 합니다.');
                    return;
                }

                // Show loading
                const btn = $(this);
                const originalText = btn.html();
                btn.html('<i class="fas fa-spinner fa-spin"></i> 조회 중...');
                btn.prop('disabled', true);

                // Simulate API call
                setTimeout(() => {
                    try {
                        console.log('Generating new data for search...');
                        const newData = generateMockFaultData();
                        console.log('Search generated:', newData.length, 'items');

                        if (newData.length > 0) {
                            // Update table
                            faultDataTable.clear();
                            faultDataTable.rows.add(newData);
                            faultDataTable.draw();
                            console.log('Table updated with new data');

                            // Update chart with same data
                            setTimeout(() => {
                                updateChart();
                            }, 100);

                            updateDataCount(newData.length);
                            updateFaultCountCards();
                            window.ToastNotifications.success(`${newData.length}건의 데이터를 조회했습니다.`);
                        } else {
                            window.ToastNotifications.warning('조회된 데이터가 없습니다.');
                        }
                    } catch (error) {
                        console.error('Error during search:', error);
                        window.ToastNotifications.error('데이터 조회 중 오류가 발생했습니다.');
                    }

                    btn.html(originalText);
                    btn.prop('disabled', false);
                }, 1500);
            });

            // Reset filter
            $('#resetFilter').click(function() {
                $('#totalFilter').val('all');
                $('#dcuFilter').val('all');
                $('#faultTypeFilter').val('all');
                $('#faultLevelFilter').val('all');
                $('#periodSelect').val('1hour');
                $('#startDate').val('2025-07-18');
                $('#endDate').val('2025-07-18');

                // Enable date inputs for custom selection
                $('#startDate, #endDate').prop('disabled', false);

                // Clear table filter
                faultDataTable.search('').draw();
                updateFaultCountCards();

                updateChart();
                window.ToastNotifications.info('필터가 초기화되었습니다.');
            });

            // Period select change event
            $('#periodSelect').change(function() {
                const selectedPeriod = $(this).val();
                const now = new Date();
                let startDate, endDate;

                if (selectedPeriod === 'custom') {
                    // Enable date inputs for custom selection
                    $('#startDate, #endDate').prop('disabled', false);
                } else {
                    // Disable date inputs and set predefined dates
                    $('#startDate, #endDate').prop('disabled', true);

                    // Calculate date range based on selection
                    endDate = new Date(now);
                    startDate = new Date(now);

                    switch(selectedPeriod) {
                        case '1hour':
                            startDate.setHours(startDate.getHours() - 1);
                            break;
                        case '1day':
                            startDate.setDate(startDate.getDate() - 1);
                            break;
                        case '7days':
                            startDate.setDate(startDate.getDate() - 7);
                            break;
                        case '1month':
                            startDate.setMonth(startDate.getMonth() - 1);
                            break;
                    }

                    // Format dates for input fields
                    const formatDate = (date) => {
                        return date.toISOString().split('T')[0];
                    };

                    $('#startDate').val(formatDate(startDate));
                    $('#endDate').val(formatDate(endDate));
                }
            });

            // Initialize period select functionality
            $('#periodSelect').trigger('change');

            // Export functions
            $('#exportFaultData').click(function() {
                window.ToastNotifications.info('Excel 파일을 생성하는 중입니다...');
                try {
                    // Create workbook with data only (no chart)
                    createExcelWithData();
                    window.ToastNotifications.success('Excel 파일이 다운로드되었습니다.');
                } catch (error) {
                    console.error('Excel export error:', error);
                    window.ToastNotifications.error('Excel 파일 생성 중 오류가 발생했습니다.');
                }
            });



            $('#exportPdfData').click(function() {
                window.ToastNotifications.info('PDF 보고서를 생성하는 중입니다...');
                try {
                    createPdfReport();
                    window.ToastNotifications.success('PDF 보고서가 다운로드되었습니다.');
                } catch (error) {
                    console.error('PDF export error:', error);
                    window.ToastNotifications.error('PDF 보고서 생성 중 오류가 발생했습니다.');
                }
            });

            // Create Excel file with data only
            function createExcelWithData() {
                const wb = XLSX.utils.book_new();

                // Get table data
                const tableData = faultDataTable.data().toArray();
                const headers = ['시간', 'DCU', 'Busway', 'Line', 'Type', '등급', '알람메시지(예시)'];

                // Format data for Excel
                const excelData = [headers];
                tableData.forEach(row => {
                    excelData.push([
                        row.timestamp,
                        row.dcu,
                        row.busway,
                        row.line,
                        row.type,
                        row.level,
                        row.message
                    ]);
                });

                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(excelData);

                // Set column widths
                ws['!cols'] = [
                    { width: 15 }, // 시간
                    { width: 10 }, // DCU
                    { width: 12 }, // Busway
                    { width: 10 }, // Line
                    { width: 10 }, // Type
                    { width: 12 }, // 등급
                    { width: 40 }  // 알람메시지
                ];

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, '장애조회데이터');

                // Generate filename with timestamp
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `장애조회_${dateStr}.xlsx`;

                // Write and download
                XLSX.writeFile(wb, filename);
            }

            // Create PDF report with chart and data (Korean/English hybrid)
            function createPdfReport() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');

                let yPosition = 20;

                // Header - mix of Korean and English for better readability
                doc.setFontSize(18);
                doc.text('Fault Inquiry Report', 105, yPosition, { align: 'center' });
                yPosition += 8;

                doc.setFontSize(14);
                doc.text('(장애조회 보고서)', 105, yPosition, { align: 'center' });
                yPosition += 8;

                doc.setFontSize(12);
                doc.text('simpleEye DCIM System', 105, yPosition, { align: 'center' });
                yPosition += 15;

                // Report generation time
                doc.setFontSize(11);
                const now = new Date();
                const reportTime = now.toLocaleDateString('ko-KR') + ' ' + now.toLocaleTimeString('ko-KR');
                doc.text(`Report Generated: ${reportTime}`, 20, yPosition);
                yPosition += 12;

                // Filter information
                doc.setFontSize(12);
                doc.text('Search Conditions (조회 조건)', 20, yPosition);
                yPosition += 8;

                doc.setFontSize(10);
                const searchDate = $('#searchDate').val() || '2025-07-18';
                const startTime = $('#startTime').val() || '12:00';
                const endTime = $('#endTime').val() || '12:00';

                doc.text(`Date (조회일자): ${searchDate}`, 25, yPosition);
                yPosition += 6;
                doc.text(`Time Range (시간범위): ${startTime} ~ ${endTime}`, 25, yPosition);
                yPosition += 12;

                // Add chart image if available
                if (faultTrendChart) {
                    try {
                        const chartImage = faultTrendChart.getDataURL({
                            type: 'png',
                            backgroundColor: '#ffffff',
                            pixelRatio: 2
                        });

                        doc.setFontSize(12);
                        doc.text('Fault Trend Chart (장애 트렌드 차트)', 20, yPosition);
                        yPosition += 10;

                        // Add chart image (scaled to fit page)
                        const imgWidth = 170;
                        const imgHeight = 80;
                        doc.addImage(chartImage, 'PNG', 20, yPosition, imgWidth, imgHeight);
                        yPosition += imgHeight + 15;
                    } catch (e) {
                        console.warn('Chart image could not be added to PDF:', e);
                        doc.text('Chart image could not be loaded (차트 이미지를 불러올 수 없습니다)', 20, yPosition);
                        yPosition += 10;
                    }
                }

                // Data table
                doc.setFontSize(12);
                doc.text('Fault Data (장애 데이터)', 20, yPosition);
                yPosition += 10;

                // Get table data
                const tableData = faultDataTable.data().toArray();
                const tableRows = [];

                tableData.forEach(row => {
                    tableRows.push([
                        row.timestamp,
                        row.dcu,
                        row.busway,
                        row.line,
                        row.type,
                        row.level,
                        row.message.substring(0, 30) + '...' // Truncate long messages
                    ]);
                });

                // Add table using autoTable plugin
                doc.autoTable({
                    head: [['Time', 'DCU', 'Busway', 'Line', 'Type', 'Level', 'Message']],
                    body: tableRows.slice(0, 20), // Limit to first 20 rows for PDF
                    startY: yPosition,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [139, 92, 246],
                        textColor: 255,
                        fontSize: 9
                    },
                    bodyStyles: {
                        fontSize: 8,
                        textColor: 50
                    },
                    alternateRowStyles: {
                        fillColor: [248, 249, 250]
                    },
                    margin: { left: 20, right: 20 },
                    columnStyles: {
                        0: { cellWidth: 40 },
                        1: { cellWidth: 30, halign: 'center' },
                        2: { cellWidth: 30, halign: 'center' },
                        3: { cellWidth: 35, halign: 'center' }
                    }
                });

                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                    doc.text('simpleEye DCIM System', 20, 290);
                }

                // Generate filename and save
                const filename = `FaultReport_${now.toISOString().slice(0, 19).replace(/:/g, '-')}.pdf`;
                doc.save(filename);
            }

            // Chart controls
            $('#chartFullscreen').click(function() {
                const chartContainer = document.getElementById('faultTrendChart');
                if (chartContainer.requestFullscreen) {
                    chartContainer.requestFullscreen();
                }
            });

            $('#exportChartImage').click(function() {
                if (faultTrendChart) {
                    const url = faultTrendChart.getDataURL({
                        type: 'png',
                        backgroundColor: '#1a1a1a'
                    });
                    const link = document.createElement('a');
                    link.download = `fault-trend-${new Date().toISOString().split('T')[0]}.png`;
                    link.href = url;
                    link.click();
                    window.ToastNotifications.success('차트 이미지가 저장되었습니다.');
                }
            });

            // Update data count
            function updateDataCount(count) {
                $('#dataCount').text(`총 ${count}건`);
            }

            // Initialize data count and fault cards
            updateDataCount(faultDataTable.data().length);
            updateFaultCountCards();

            // Page size change
            $('#pageSize').change(function() {
                faultDataTable.page.len(parseInt($(this).val())).draw();
            });

            // Fault count cards functions
            function updateFaultCountCards() {
                if (!faultDataTable) return;

                // Get filtered/searched data instead of all data
                const filteredData = faultDataTable.rows({search: 'applied'}).data().toArray();

                let counts = {
                    breakerError: 0,
                    tripError: 0,
                    commError: 0,
                    voltageError: 0,
                    currentError: 0,
                    powerError: 0
                };

                filteredData.forEach(row => {
                    const type = row[4] || ''; // Type column
                    const alarmMessage = (row[6] || '').toLowerCase(); // Alarm message column

                    // Check for different fault types based on Type and alarm message
                    if (type === 'trip' || alarmMessage.includes('trip')) {
                        counts.tripError++;
                    } else if (type === 'comm' || alarmMessage.includes('통신') || alarmMessage.includes('comm')) {
                        counts.commError++;
                    } else if (type === 'i_r' || alarmMessage.includes('전압') || alarmMessage.includes('voltage')) {
                        counts.voltageError++;
                    } else if (type === 'di1' || alarmMessage.includes('전류') || alarmMessage.includes('current')) {
                        counts.currentError++;
                    } else if (alarmMessage.includes('전력') || alarmMessage.includes('power') || alarmMessage.includes('kw')) {
                        counts.powerError++;
                    } else if (alarmMessage.includes('차단기') || alarmMessage.includes('breaker')) {
                        counts.breakerError++;
                    } else {
                        // Default categorization based on type
                        if (type === 'i_r') counts.voltageError++;
                        else if (type === 'di1') counts.currentError++;
                        else if (type === 'comm') counts.commError++;
                        else if (type === 'trip') counts.tripError++;
                    }
                });

                // Update card displays
                document.getElementById('breakerErrorCount').textContent = counts.breakerError;
                document.getElementById('tripErrorCount').textContent = counts.tripError;
                document.getElementById('commErrorCount').textContent = counts.commError;
                document.getElementById('voltageErrorCount').textContent = counts.voltageError;
                document.getElementById('currentErrorCount').textContent = counts.currentError;
                document.getElementById('powerErrorCount').textContent = counts.powerError;

                console.log('Fault counts updated:', counts);
            }

            // Column-specific search function
            function initializeColumnSearch() {
                // Individual column search
                $('.column-search').on('keyup', function() {
                    const column = $(this).data('column');
                    const value = this.value;

                    faultDataTable
                        .column(column)
                        .search(value)
                        .draw();

                    updateFaultCountCards();
                    updateDataCount();
                });

                console.log('Column search initialized');
            }

            // Update data count after filtering
            function updateDataCount() {
                const info = faultDataTable.page.info();
                document.getElementById('dataCount').textContent = `총 ${info.recordsDisplay}건`;
            }

            // Initialize column search after DataTable is ready
            initializeColumnSearch();

            // Filter change events for new fault type and level filters
            $('#faultTypeFilter, #faultLevelFilter, #totalFilter, #dcuFilter').on('change', function() {
                applyAdvancedFilters();
            });

            // Apply advanced filters function
            function applyAdvancedFilters() {
                // Get filter values
                const faultType = $('#faultTypeFilter').val();
                const faultLevel = $('#faultLevelFilter').val();

                // Create custom search function
                $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                    // Check fault type filter
                    if (faultType !== 'all') {
                        const type = data[4] || '';
                        const message = data[6] || '';

                        let typeMatch = false;
                        switch(faultType) {
                            case 'trip': 
                                typeMatch = type === 'trip' || message.toLowerCase().includes('trip');
                                break;
                            case 'comm': 
                                typeMatch = type === 'comm' || message.toLowerCase().includes('통신') || message.toLowerCase().includes('comm');
                                break;
                            case 'i_r': 
                                typeMatch = type === 'i_r' || message.toLowerCase().includes('전압') || message.toLowerCase().includes('voltage');
                                break;
                            case 'di1': 
                                typeMatch = type === 'di1' || message.toLowerCase().includes('전류') || message.toLowerCase().includes('current');
                                break;
                            case 'power': 
                                typeMatch = message.toLowerCase().includes('전력') || message.toLowerCase().includes('power') || message.toLowerCase().includes('kw');
                                break;
                            case 'breaker': 
                                typeMatch = message.toLowerCase().includes('차단기') || message.toLowerCase().includes('breaker');
                                break;
                            default:
                                typeMatch = true;
                        }

                        if (!typeMatch) return false;
                    }

                    // Check fault level filter
                    if (faultLevel !== 'all') {
                        const levelBadge = data[5] || '';
                        let levelMatch = false;

                        switch(faultLevel) {
                            case 'H': 
                                levelMatch = levelBadge.includes('bg-danger');
                                break;
                            case 'HH': 
                                levelMatch = levelBadge.includes('bg-warning');
                                break;
                            case 'L': 
                                levelMatch = levelBadge.includes('Low') || levelBadge.includes('bg-info');
                                break;
                            case 'normal': 
                                levelMatch = levelBadge.includes('bg-success');
                                break;
                            default:
                                levelMatch = true;
                        }

                        if (!levelMatch) return false;
                    }

                    return true;
                });

                // Redraw table with filters applied
                faultDataTable.draw();

                // Update fault count cards with filtered data
                updateFaultCountCards();

                // Remove the custom search function to avoid accumulation
                $.fn.dataTable.ext.search.pop();
            }

            // Auto refresh every 5 minutes
            setInterval(() => {
                if ($('#autoRefresh').is(':checked')) {
                    $('#searchFaultData').click();
                }
            }, 300000);
        });
    </script>
</body>
</html>